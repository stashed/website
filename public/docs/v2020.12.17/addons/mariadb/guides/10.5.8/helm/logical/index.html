<!doctype html><html lang=en><head><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-62096468-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#5E2DEA"><title>Stash by AppsCode</title><meta name=description content="Stash by AppsCode is a cloud native data backup and recovery solution for Kubernetes workloads, volumes and databases"><meta name=author content="AppsCode Inc."><meta name=keywords content="kubernetes appscode backup disaster recovery volume"><link rel=apple-touch-icon sizes=57x57 href=/assets/images/products/stash/icons/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/assets/images/products/stash/icons/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/assets/images/products/stash/icons/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/assets/images/products/stash/icons/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/assets/images/products/stash/icons/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/assets/images/products/stash/icons/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/assets/images/products/stash/icons/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/assets/images/products/stash/icons/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/assets/images/products/stash/icons/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/assets/images/products/stash/icons/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/assets/images/products/stash/icons/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/assets/images/products/stash/icons/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/assets/images/products/stash/icons/favicon-16x16.png><link rel=manifest href=/assets/images/products/stash/icons/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/assets/images/products/stash/icons/ms-icon-144x144.png"><meta itemprop=name content="Stash by AppsCode"><meta itemprop=description content="Stash by AppsCode is a cloud native data backup and recovery solution for Kubernetes workloads, volumes and databases"><meta itemprop=image content="https://stash.run/assets/images/products/stash/stash-1280x640.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@KubeStash"><meta name=twitter:title content="Stash by AppsCode"><meta name=twitter:creator content="@KubeStash"><meta name=twitter:description content="Stash by AppsCode is a cloud native data backup and recovery solution for Kubernetes workloads, volumes and databases"><meta name=twitter:image:src content="https://stash.run/assets/images/products/stash/stash-1280x640.png"><meta property="og:url" content="https://stash.run"><meta property="og:title" content="Stash by AppsCode"><meta property="og:description" content="Stash by AppsCode is a cloud native data backup and recovery solution for Kubernetes workloads, volumes and databases"><meta property="og:site_name" content="Stash by AppsCode"><meta property="og:image" content="https://stash.run/assets/images/products/stash/stash-1280x640.png"><meta property="og:type" content="article"><link rel=stylesheet href=/assets/css/font-awesome.min.css><link href=https://unpkg.com/aos@2.3.1/dist/aos.css rel=stylesheet><link rel=stylesheet href=/assets/css/bulma-carousel.min.css><link rel=stylesheet href=/assets/css/bulma-tooltip.min.css><link rel=stylesheet href=/assets/css/bulma.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/keen-slider@latest/keen-slider.min.css><link rel=stylesheet href=/assets/sass/main.min.7c4a3c9b9b725ecf3969bcbc5840e69b185f0fac32d96a51f603a97a3293fcc7.css></head><body class=stash><header><div class=header-top><div class="container section"><nav class=navbar><div class=navbar-brand><a class=navbar-item href=https://appscode.com><img src=/assets/images/products/appscode/appscode.png alt=AppsCode></a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=acNav1><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div id=acNav1 class="navbar-menu main-menu"><div class=navbar-end><div class=navbar-start><div class="navbar-item has-dropdown ac-is-hoverable"><a class=navbar-link>Products</a><div class=ac-megamenu><div class=columns><div class="column is-6"><div class=columns><div class="column is-12 br-1"><a href=https://kubedb.com class="single-product-item is-kubedb"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/kubedb/kubedb-icon.png alt=KubeDB></div><h5>KubeDB</h5></div><div class=menu-body><p>Run production-grade Databases on Kubernetes</p></div></a><a href=https://stash.run class="single-product-item is-stash"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/stash/stash-icon.png alt=Stash></div><h5>Stash</h5></div><div class=menu-body><p>Backup your Kubernetes Stateful Applications</p></div></a><a href=https://kubevault.com class="single-product-item is-kubevault"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/kubevault/kubevault-icon.png alt=KubeVault></div><h5>KubeVault</h5></div><div class=menu-body><p>Tools for running HashiCorp Vault on Kubernetes</p></div></a></div></div></div><div class="column is-6"><div class=columns><div class="column is-12"><a href=https://byte.builders class="single-product-item byte-builder kd-orange"><div class=menu-header><p class=intro>Introducing....</p><h5>ByteBuilders</h5></div><div class=menu-body><p>Cloud reimagined for the age of Kubernetes</p></div><p class=learn-more-btn>Learn more
<span class=icon><i class="fa fa-long-arrow-right" aria-hidden=true></i></span></p></a><a href=https://kubeform.com class="single-product-item is-kubeform"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/kubeform/kubeform-icon.png alt=Kubeform></div><h5>Kubeform</h5></div><div class=menu-body><p>Provision cloud resources using Kubernetes CRDs & Terraform</p></div></a></div></div></div></div></div></div><div class="navbar-item has-dropdown ac-is-hoverable"><a class=navbar-link>Open Source</a><div class=ac-megamenu><div class=columns><div class="column is-6"><div class=columns><div class="column is-12 br-1"><a href=https://voyagermesh.com class="single-product-item is-voyager"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/voyager/voyager-icon.png alt=Voyager></div><h5>Voyager</h5></div><div class=menu-body><p>Secure HAProxy Ingress Controller for
Kubernetes</p></div></a><a href=https://appscode.com/products/guard/ class="single-product-item is-guard"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/guard/guard-icon.png alt=Guard></div><h5>Guard</h5></div><div class=menu-body><p>Kubernetes Authentication WebHook Server</p></div></a><a href=https://appscode.com/products/kubed/ class="single-product-item is-kubed"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/kubed/kubed-icon.png alt=Kubed></div><h5>Kubed</h5></div><div class=menu-body><p>Kubernetes cluster manager daemon</p></div></a></div></div></div><div class="column is-6"><div class=columns><div class="column is-12"><a href=https://pharmer.cloud class="single-product-item is-pharmer"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/pharmer/pharmer-icon.png alt=Pharmer></div><h5>Pharmer</h5></div><div class=menu-body><p>Kubernetes Cluster Manager using Kubeadm & Cluster API</p></div></a><a href=https://appscode.com/products/swift/ class="single-product-item is-swift"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/swift/swift-icon.png alt=Swift></div><h5>Swift</h5></div><div class=menu-body><p>Ajax friendly Helm Tiller Proxy</p></div></a><a href=https://appscode.com/products/searchlight/ class="single-product-item is-searchlight"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/searchlight/searchlight-icon.png alt=Searchlight></div><h5>Searchlight</h5></div><div class=menu-body><p>Alerts for Kubernetes</p></div></a></div></div></div></div></div></div><div class="navbar-item has-dropdown ac-is-hoverable"><a class=navbar-link>Services</a><div class=ac-dropdown><a class=navbar-item href=https://appscode.com/consulting/>Consulting</a>
<a class=navbar-item href=https://appscode.com/training/>Training</a>
<a class=navbar-item href=https://appscode.com/support/>Support</a></div></div><a class=navbar-item href=https://blog.byte.builders>Blog</a>
<a class=navbar-item href=https://appscode.com/contact/>Contact Us</a></div><div class=navbar-item><div class="buttons main-menu-button-top"><a class="button is-small for-chat" href=https://slack.appscode.com><span><img src=/assets/images/icon/slack.png alt></span>Slack</a>
<a class="button is-small for-support" href=https://appscode.freshdesk.com><span><img src=/assets/images/icon/chat.png alt></span>Support Portal</a></div></div></div></div></nav></div></div><div class="header-bottom-area header-area kubedb-primary-bg customize-kubedb fixed-menu"><div class="container section"><nav class=navbar><div class=navbar-brand><a class=navbar-item href=https://stash.run><img src=/assets/images/products/stash/stash-white.png alt=Stash></a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=acNav><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div id=acNav class="navbar-menu main-menu"><div class=navbar-end><div class=navbar-start><a href=/features/ class=navbar-item>Features</a>
<a href=/pricing/ class=navbar-item>Pricing</a>
<a href=/docs/v2020.12.17/welcome/ class=navbar-item>Documentation</a><div class="navbar-item has-dropdown ac-is-hoverable"><a class=navbar-link>Community</a><div class=ac-dropdown><a href=https://github.com/stashed class=navbar-item>GitHub</a>
<a href=https://twitter.com/KubeStash class=navbar-item>Twitter</a>
<a href=https://slack.appscode.com class=navbar-item>Slack</a></div></div></div><div class=navbar-item><div class="buttons main-menu-button"><img style=height:24px alt="GitHub Stars" src="https://img.shields.io/badge/dynamic/json?style=flat&labelColor=1B3D4B&color=06A64F&logoColor=white&logo=github&label=stars&query=%24.stars&url=https://github-stars.appscode.workers.dev/user/stashed">
&nbsp;&nbsp;&nbsp;
<img style=height:24px alt="GitHub Forks" src="https://img.shields.io/badge/dynamic/json?style=flat&labelColor=1B3D4B&color=06A64F&logoColor=white&logo=github&label=forks&query=%24.forks&url=https://github-stars.appscode.workers.dev/user/stashed">
&nbsp;&nbsp;&nbsp;
<img style=height:24px alt="Docker Pulls" src="https://img.shields.io/docker/pulls/appscode/stash?style=flat&labelColor=1B3D4B&color=06A64F&logoColor=white&logo=docker&label=pulls"></div></div></div></div></nav></div></div><div class=documentation-menu><div class="container section"><div class=is-centered><div class="is-half has-text-centered-desktop"><div class=responsive-menu><a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=acNav3><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><nav class=documentation-navbar><div id=acNav3 class="navbar-menu nav-menu main-menu"><div class=navbar-centered><div class=navbar-start><a href=/docs/v2020.12.17/ class=navbar-item>Welcome</a>
<a href=/docs/v2020.12.17/concepts/ class=navbar-item>Concepts</a>
<a href=/docs/v2020.12.17/setup/ class=navbar-item>Setup</a><div class="navbar-item has-dropdown ac-is-hoverable"><a class=navbar-link>Guides</a><div class=ac-dropdown><a href=/docs/v2020.12.17/guides/latest/ class=navbar-item>Latest Guides</a>
<a href=/docs/v2020.12.17/guides/v1alpha1/ class=navbar-item>v1alpha1 Guides</a></div></div><div class="navbar-item has-dropdown ac-is-hoverable"><a class=navbar-link>Addons</a><div class=ac-dropdown><a href=/docs/v2020.12.17/addons/postgres/ class=navbar-item>Postgres</a>
<a href=/docs/v2020.12.17/addons/elasticsearch/ class=navbar-item>Elasticsearch</a>
<a href=/docs/v2020.12.17/addons/mongodb/ class=navbar-item>MongoDB</a>
<a href=/docs/v2020.12.17/addons/mysql/ class=navbar-item>MySQL</a>
<a href=/docs/v2020.12.17/addons/percona-xtradb/ class=navbar-item>Percona XtraDB</a>
<a href=/docs/v2020.12.17/addons/mariadb/ class=navbar-item>MariaDB</a></div></div><div class="navbar-item has-dropdown ac-is-hoverable"><a class=navbar-link>Reference</a><div class=ac-dropdown><a href=/docs/v2020.12.17/reference/operator/ class=navbar-item>Stash Operator</a>
<a href=/docs/v2020.12.17/reference/cli/ class=navbar-item>Stash CLI</a></div></div></div></div></div></nav></div></div></div></div></header><div class=documentation-area><div class="container section"><div class=columns><div class="column is-3"><div class=kd-left-sidebar><div class=trial-button><a href=/docs/v2020.12.17/setup/ class="button is-fullwidth">Try Now for FREE!</a></div><div class=kd-version><div class=dropdown><div class=dropdown-trigger><button class="button is-fullwidth" aria-haspopup=true aria-controls=dropdown-menu3>
<span><strong class=icon><i class="fa fa-cog" aria-hidden=true></i></strong>v2020.12.17</span>
<span class=new-item>Latest</span>
<span class="icon is-small"><i class="fa fa-angle-down" aria-hidden=true></i></span></button></div><div class=dropdown-menu id=dropdown-menu3 role=menu><div class=dropdown-content><a href=https://github.com/stashed/docs/tree/master/docs target=_blank class=dropdown-item>master</a>
<a href=/docs/v2020.12.17/ class=dropdown-item>v2020.12.17<div class=tag>Latest</div></a><a href=/docs/v2020.11.17/ class=dropdown-item>v2020.11.17</a>
<a href=/docs/v2020.11.06/ class=dropdown-item>v2020.11.06</a>
<a href=/docs/v2020.10.30/ class=dropdown-item>v2020.10.30</a>
<a href=/docs/v2020.10.29/ class=dropdown-item>v2020.10.29</a>
<a href=/docs/v2020.10.21/ class=dropdown-item>v2020.10.21</a>
<a href=/docs/v2020.09.29/ class=dropdown-item>v2020.09.29</a>
<a href=/docs/v2020.09.16/ class=dropdown-item>v2020.09.16</a>
<a href=/docs/v2020.08.27/ class=dropdown-item>v2020.08.27</a>
<a href=/docs/v0.9.0-rc.6/ class=dropdown-item>v0.9.0-rc.6</a></div></div></div></div><div class=kd-sidebar-menu><div class=item><input type=checkbox id=0defbabebf89c53fecef151e8269440a-1>
<label for=0defbabebf89c53fecef151e8269440a-1><a href=/docs/v2020.12.17/addons/mariadb/>MariaDB</a></label></div><div class=item><input type=checkbox id=0defbabebf89c53fecef151e8269440a-2>
<label for=0defbabebf89c53fecef151e8269440a-2><a href=/docs/v2020.12.17/addons/mariadb/overview/>How does it works?</a></label></div><div class=item><input type=checkbox id=0defbabebf89c53fecef151e8269440a-3>
<label for=0defbabebf89c53fecef151e8269440a-3><a>Setup</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.12.17/addons/mariadb/setup/install/>Install</a></li><li><a href=/docs/v2020.12.17/addons/mariadb/setup/uninstall/>Uninstall</a></li></ul></div></div><div class=item><input type=checkbox id=0defbabebf89c53fecef151e8269440a-4 checked>
<label for=0defbabebf89c53fecef151e8269440a-4><a>Guides</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><div class=item><input type=checkbox id=0defbabebf89c53fecef151e8269440a-5 checked>
<label for=0defbabebf89c53fecef151e8269440a-5><a>10.5.8</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><div class=item><input type=checkbox id=0defbabebf89c53fecef151e8269440a-6 checked>
<label for=0defbabebf89c53fecef151e8269440a-6><a>Deployed with Helm</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li class=is-active><a href=/docs/v2020.12.17/addons/mariadb/guides/10.5.8/helm/logical/>Logical Backup</a></li></ul></div></div></ul></div></div></ul></div></div></div></div></div><div class="column is-7"><div class=full-info><h1 id=take-a-logical-backup-of-the-mariadb-database-using-stash>Take a logical backup of the MariaDB database using Stash</h1><p>Stash <code>v0.11.8+</code> supports backup and restoration of MariaDB databases. This guide will show you how you can take a logical backup of your MariaDB databases and restore them using Stash.</p><h2 id=before-you-begin>Before You Begin</h2><ul><li>At first, you need to have a Kubernetes cluster, and the <code>kubectl</code> command-line tool must be configured to communicate with your cluster.</li><li>Install Stash in your cluster following the steps <a href=/docs/v2020.12.17/setup/README>here</a>.</li><li>Install MariaDB addon for Stash following the steps <a href=/docs/v2020.12.17/addons/mariadb/setup/install>here</a>.</li><li>If you are not familiar with how Stash backup and restore MariaDB databases, please check the following guide <a href=/docs/v2020.12.17/addons/mariadb/overview>here</a>.</li></ul><p>You have to be familiar with following custom resources:</p><ul><li><a href=/docs/v2020.12.17/concepts/objects/appbinding>AppBinding</a></li><li><a href=/docs/v2020.12.17/concepts/objects/function>Function</a></li><li><a href=/docs/v2020.12.17/concepts/objects/task>Task</a></li><li><a href=/docs/v2020.12.17/concepts/objects/backupconfiguration>BackupConfiguration</a></li><li><a href=/docs/v2020.12.17/concepts/objects/backupsession>BackupSession</a></li><li><a href=/docs/v2020.12.17/concepts/objects/restoresession>RestoreSession</a></li></ul><p>To keep things isolated, we are going to use a separate namespace called <code>demo</code> throughout this tutorial. Create <code>demo</code> namespace if you haven&rsquo;t created it yet.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl create ns demo
namespace/demo created
</code></pre></div><blockquote><p>Note: YAML files used in this tutorial are stored <a href=https://github.com/stashed/mariadb/tree/10.5.8/docs/helm/examples>here</a>.</p></blockquote><h2 id=prepare-mariadb>Prepare MariaDB</h2><p>In this section, we are going to deploy a MariaDB database. Then, we are going to insert some sample data into it.</p><h3 id=deploy-mariadb>Deploy MariaDB</h3><p>At first, let&rsquo;s deploy a MariaDB database. Here, we are going to use <a href=https://artifacthub.io/packages/helm/bitnami/mariadb>bitnami/mariadb</a> chart from <a href=https://artifacthub.io/>ArtifactHub</a>.</p><p>Let&rsquo;s deploy a MariaDB database named <code>sample-mariadb</code> using Helm as below,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Add bitnami chart registry</span>
$ helm repo add bitnami https://charts.bitnami.com/bitnami
<span style=color:#75715e># Update helm registries</span>
$ helm repo update
<span style=color:#75715e># Install bitnami/mariadb chart into demo namespace</span>
$ helm install sample-mariadb bitnami/mariadb -n demo
</code></pre></div><p>This chart will create the necessary StatefulSet, Secret, Service etc. for the database. You can easily view all the resources created by chart using <a href=https://github.com/corneliusweig/ketall>ketall</a> <code>kubectl</code> plugin as below,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get-all -n demo -l app.kubernetes.io/instance<span style=color:#f92672>=</span>sample-mariadb
NAME                                              NAMESPACE  AGE
configmap/sample-mariadb                          demo       5m59s  
endpoints/sample-mariadb                          demo       5m59s  
persistentvolumeclaim/data-sample-mariadb-0       demo       5m59s  
pod/sample-mariadb-0                              demo       5m59s  
secret/sample-mariadb                             demo       5m59s  
serviceaccount/sample-mariadb                     demo       5m59s  
service/sample-mariadb                            demo       5m59s  
controllerrevision.apps/sample-mariadb-bb8d8865b  demo       5m59s  
statefulset.apps/sample-mariadb                   demo       5m59s
</code></pre></div><p>Now, wait for the database pod <code>sample-mariadb-0</code> to go into <code>Running</code> state,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get pod -n demo sample-mariadb-0
NAME               READY   STATUS    RESTARTS   AGE
sample-mariadb-0   1/1     Running   <span style=color:#ae81ff>0</span>          11m
</code></pre></div><p>Once the database pod is in <code>Running</code> state, verify that the database is ready to accept the connections.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl logs -n demo sample-mariadb-0
mariadb 10:44:37.29 
mariadb 10:44:37.29 Welcome to the Bitnami mariadb container
...
2020-12-03 10:44:46 <span style=color:#ae81ff>0</span> <span style=color:#f92672>[</span>Note<span style=color:#f92672>]</span> /opt/bitnami/mariadb/sbin/mysqld: ready <span style=color:#66d9ef>for</span> connections.
Version: <span style=color:#e6db74>&#39;10.5.8-MariaDB&#39;</span>  socket: <span style=color:#e6db74>&#39;/opt/bitnami/mariadb/tmp/mysql.sock&#39;</span>  port: <span style=color:#ae81ff>3306</span>  Source distribution
</code></pre></div><p>From the above log, we can see the database is ready to accept connections.</p><h3 id=insert-sample-data>Insert Sample Data</h3><p>Now, we are going to exec into the database pod and create some sample data. The helm chart has created a secret with access credentials. Let&rsquo;s find out the credentials from the Secret,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ae81ff>$ kubectl get secret -n demo sample-mariadb -o yaml</span>
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>data</span>:
  <span style=color:#f92672>mariadb-password</span>: <span style=color:#ae81ff>ZlFSdzA1ZXRvbg==</span>
  <span style=color:#f92672>mariadb-root-password</span>: <span style=color:#ae81ff>Y1ZrUXA0TXdENQ==</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Secret</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>annotations</span>:
    <span style=color:#f92672>meta.helm.sh/release-name</span>: <span style=color:#ae81ff>sample-mariadb</span>
    <span style=color:#f92672>meta.helm.sh/release-namespace</span>: <span style=color:#ae81ff>demo</span>
  <span style=color:#f92672>creationTimestamp</span>: <span style=color:#e6db74>&#34;2020-12-03T10:43:43Z&#34;</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>app.kubernetes.io/instance</span>: <span style=color:#ae81ff>sample-mariadb</span>
    <span style=color:#f92672>app.kubernetes.io/managed-by</span>: <span style=color:#ae81ff>Helm</span>
    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>mariadb</span>
    <span style=color:#f92672>helm.sh/chart</span>: <span style=color:#ae81ff>mariadb-9.0.1</span>
  <span style=color:#ae81ff>....</span>
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample-mariadb</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>demo</span>
<span style=color:#f92672>type</span>: <span style=color:#ae81ff>Opaque</span>
</code></pre></div><p>Here, we are going to use the root user credential <code>mariadb-root-password</code> to insert the sample data.</p><p>At first, let&rsquo;s export the username and password as environment variables to make further commands re-usable.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>export USER_NAME<span style=color:#f92672>=</span>root
export PASSWORD<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>kubectl get secrets -n demo sample-mariadb -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.data.\mariadb-root-password}&#39;</span> | base64 -d<span style=color:#66d9ef>)</span>
</code></pre></div><p>Now, let&rsquo;s exec into the database pod and insert some sample data,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl exec -it -n demo sample-mariadb-0 -- mariadb --user<span style=color:#f92672>=</span>$USER_NAME --password<span style=color:#f92672>=</span>$PASSWORD
...
<span style=color:#75715e># Let&#39;s create a database named &#34;company&#34;</span>
MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; create database company;
Query OK, <span style=color:#ae81ff>1</span> row affected <span style=color:#f92672>(</span>0.001 sec<span style=color:#f92672>)</span>

<span style=color:#75715e># Verify that the database has been created successfully</span>
MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| company            |
| information_schema |
| my_database        |
| mysql              |
| performance_schema |
| test               |
+--------------------+
<span style=color:#ae81ff>6</span> rows in set <span style=color:#f92672>(</span>0.001 sec<span style=color:#f92672>)</span>

<span style=color:#75715e># Now, let create a table called &#34;employee&#34; in the &#34;company&#34; table</span>
MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; create table company.employees <span style=color:#f92672>(</span> name varchar<span style=color:#f92672>(</span>50<span style=color:#f92672>)</span>, salary int<span style=color:#f92672>)</span>;
Query OK, <span style=color:#ae81ff>0</span> rows affected <span style=color:#f92672>(</span>0.018 sec<span style=color:#f92672>)</span>

<span style=color:#75715e># Verify that the table has been created successfully</span>
MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; show tables in company;
+-------------------+
| Tables_in_company |
+-------------------+
| employees         |
+-------------------+
<span style=color:#ae81ff>1</span> row in set <span style=color:#f92672>(</span>0.001 sec<span style=color:#f92672>)</span>

<span style=color:#75715e># Now, let&#39;s insert a sample row in the table</span>
MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; insert into company.employees values <span style=color:#f92672>(</span><span style=color:#e6db74>&#39;John Doe&#39;</span>, 5000<span style=color:#f92672>)</span>;
Query OK, <span style=color:#ae81ff>1</span> row affected <span style=color:#f92672>(</span>0.003 sec<span style=color:#f92672>)</span>

<span style=color:#75715e># Insert another sample row</span>
MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; insert into company.employees values <span style=color:#f92672>(</span><span style=color:#e6db74>&#39;James William&#39;</span>, 7000<span style=color:#f92672>)</span>;
Query OK, <span style=color:#ae81ff>1</span> row affected <span style=color:#f92672>(</span>0.002 sec<span style=color:#f92672>)</span>

<span style=color:#75715e># Verify that the rows have been inserted into the table successfully</span>
MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; <span style=color:#66d9ef>select</span> * from company.employees;
+---------------+--------+
| name          | salary |
+---------------+--------+
| John Doe      |   <span style=color:#ae81ff>5000</span> |
| James William |   <span style=color:#ae81ff>7000</span> |
+---------------+--------+
<span style=color:#ae81ff>2</span> rows in set <span style=color:#f92672>(</span>0.001 sec<span style=color:#f92672>)</span>

MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; exit
Bye
</code></pre></div><p>We have successfully deployed a MariaDB database and inserted some sample data into it. In the subsequent sections, we are going to backup these data using Stash.</p><h2 id=prepare-for-backup>Prepare for Backup</h2><p>In this section, we are going to prepare the necessary resources (i.e. database connection information, backend information, etc.) before backup.</p><h3 id=ensure-mariadb-addon>Ensure MariaDB Addon</h3><p>At first, make sure that you have installed Stash MariaDB addon version 10.5.8. If haven&rsquo;t install the addon yet, install it by following the setup guide from <a href=/docs/v2020.12.17/addons/mariadb/setup/install>here</a>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get tasks.stash.appscode.com | grep mariadb
mariadb-backup-10.5.8    35s
mariadb-restore-10.5.8   35s
</code></pre></div><p>This addon should be able to take backup of the databases with matching major versions as discussed in <a href=/docs/v2020.12.17/addons/mariadb/README#addon-version-compatibility>Addon Version Compatibility</a>.</p><h3 id=create-appbinding>Create AppBinding</h3><p>Stash needs to know how to connect with the database. An <code>AppBinding</code> exactly provides this information. It holds the Service and Secret information of the database. You have to point to the respective <code>AppBinding</code> as a target of backup instead of the database itself.</p><p>Stash expect your database Secret to have <code>username</code> and <code>password</code> keys. If your database secret does not have them, the <code>AppBinding</code> can also help here. You can specify a <code>secretTransforms</code> section with the mapping between the current keys and the desired keys.</p><p>Here, is the YAML of the <code>AppBinding</code> that we are going to create for the MariaDB database we have deployed earlier.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>appcatalog.appscode.com/v1alpha1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AppBinding</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample-mariadb</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>demo</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>clientConfig</span>:
    <span style=color:#f92672>service</span>:
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample-mariadb</span>
      <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/</span>
      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>3306</span>
      <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>mysql</span>
  <span style=color:#f92672>secret</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample-mariadb</span>
  <span style=color:#f92672>secretTransforms</span>:
  - <span style=color:#f92672>addKey</span>:
      <span style=color:#f92672>key</span>: <span style=color:#ae81ff>username</span>
      <span style=color:#f92672>stringValue</span>: <span style=color:#ae81ff>root</span>
  - <span style=color:#f92672>renameKey</span>:
      <span style=color:#f92672>from</span>: <span style=color:#ae81ff>mariadb-root-password</span>
      <span style=color:#f92672>to</span>: <span style=color:#ae81ff>password</span>
  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>mariadb</span>
  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>10.5.8</span>
</code></pre></div><p>Here,</p><ul><li><strong>.spec.clientConfig.service</strong> specifies the Service information to use to connects with the database.</li><li><strong>.spec.secret</strong> specifies the name of the Secret that holds necessary credentials to access the database.</li><li><strong>.spec.secretTransforms</strong> specifies the transformations required to achieve the desired keys from the current Secret. You can apply the following transformations here:<ul><li><strong>addKey</strong>: If your database Secret does not have an equivalent key expected by Stash, you can add the key using <code>addKey</code> transformation. Here, our deployed MariaDB Secret didn&rsquo;t have any key equivalent to <code>username</code>. Hence, we are adding the key using <code>addKey</code> transformation.</li><li><strong>renameKey</strong>: If your database Secret does not have a key expected by Stash but it has an equivalent key that is used for the same purpose, you can use <code>renameKey</code> transformation to specify the mapping between the keys. For example, our MariaDB Secret didn&rsquo;t have <code>password</code> key but it has an equivalent <code>mariadb-root-password</code> key that contains password for the root user. Hence, we are telling Stash using <code>renameKey</code> transformation that the <code>mariadb-root-password</code> should be used as <code>password</code> key.</li><li><strong>addKeysFrom</strong>: You can also merge keys from another Secret using <code>addKeysFrom</code> transformation. You have to specify the respective Secret name and namespace as below:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>addKeysFrom</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>&lt;secret name&gt;</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>&lt;secret namespace&gt;</span>
</code></pre></div></li></ul></li><li><code>spec.type</code> specifies the type of the database. This is particularly helpful in auto-backup where you want to use different path prefixes for different types of database.</li></ul><p>Let&rsquo;s create the <code>AppBinding</code> we have shown above,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl apply -f https://github.com/stashed/mariadb/tree/10.5.8/docs/helm/examples/appbinding.yaml
appbinding.appcatalog.appscode.com/sample-mariadb created
</code></pre></div><blockquote><p>The <code>secretTransforms</code> does not modify your original database Secret. Stash just uses those transformations to obtain the desired keys from the original Secret.</p></blockquote><h3 id=prepare-backend>Prepare Backend</h3><p>We are going to store our backed up data into a GCS bucket. So, we need to create a Secret with GCS credentials and a <code>Repository</code> object with the bucket information. If you want to use a different backend, please read the respective backend configuration doc from <a href=/docs/v2020.12.17/guides/latest/backends/overview>here</a>.</p><p><strong>Create Storage Secret:</strong></p><p>At first, let&rsquo;s create a secret called <code>gcs-secret</code> with access credentials to our desired GCS bucket,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ echo -n <span style=color:#e6db74>&#39;changeit&#39;</span> &gt; RESTIC_PASSWORD
$ echo -n <span style=color:#e6db74>&#39;&lt;your-project-id&gt;&#39;</span> &gt; GOOGLE_PROJECT_ID
$ cat downloaded-sa-json.key &gt; GOOGLE_SERVICE_ACCOUNT_JSON_KEY
$ kubectl create secret generic -n demo gcs-secret <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --from-file<span style=color:#f92672>=</span>./RESTIC_PASSWORD <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --from-file<span style=color:#f92672>=</span>./GOOGLE_PROJECT_ID <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --from-file<span style=color:#f92672>=</span>./GOOGLE_SERVICE_ACCOUNT_JSON_KEY
secret/gcs-secret created
</code></pre></div><p><strong>Create Repository:</strong></p><p>Now, crete a <code>Repository</code> object with the information of your desired bucket. Below is the YAML of <code>Repository</code> object we are going to create,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>stash.appscode.com/v1alpha1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Repository</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gcs-repo</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>demo</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>backend</span>:
    <span style=color:#f92672>gcs</span>:
      <span style=color:#f92672>bucket</span>: <span style=color:#ae81ff>stash-testing</span>
      <span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>/demo/mariadb/sample-mariadb</span>
    <span style=color:#f92672>storageSecretName</span>: <span style=color:#ae81ff>gcs-secret</span>
</code></pre></div><p>Let&rsquo;s create the <code>Repository</code> we have shown above,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl create -f https://github.com/stashed/mariadb/raw/10.5.8/docs/helm/examples/repository.yaml
repository.stash.appscode.com/gcs-repo created
</code></pre></div><p>Now, we are ready to backup our database into our desired backend.</p><h3 id=backup>Backup</h3><p>To schedule a backup, we have to create a <code>BackupConfiguration</code> object targeting the respective <code>AppBinding</code> of our desired database. Then Stash will create a CronJob to periodically backup the database.</p><h4 id=create-backupconfiguration>Create BackupConfiguration</h4><p>Below is the YAML for <code>BackupConfiguration</code> object we care going to use to backup the <code>sample-mariadb</code> database we have deployed earlier,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>stash.appscode.com/v1beta1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>BackupConfiguration</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample-mariadb-backup</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>demo</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>schedule</span>: <span style=color:#e6db74>&#34;*/5 * * * *&#34;</span>
  <span style=color:#f92672>task</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mariadb-backup-10.5.8</span>
  <span style=color:#f92672>repository</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gcs-repo</span>
  <span style=color:#f92672>target</span>:
    <span style=color:#f92672>ref</span>:
      <span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>appcatalog.appscode.com/v1alpha1</span>
      <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AppBinding</span>
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample-mariadb</span>
  <span style=color:#f92672>retentionPolicy</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>keep-last-5</span>
    <span style=color:#f92672>keepLast</span>: <span style=color:#ae81ff>5</span>
    <span style=color:#f92672>prune</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><p>Here,</p><ul><li><code>.spec.schedule</code> specifies that we want to backup the database at 5 minutes intervals.</li><li><code>.spec.task.name</code> specifies the name of the Task object that specifies the necessary Functions and their execution order to backup a MariaDB database.</li><li><code>.spec.target.ref</code> refers to the AppBinding object that holds the connection information of our targeted database.</li></ul><p>Let&rsquo;s create the <code>BackupConfiguration</code> object we have shown above,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl create -f https://github.com/stashed/mariadb/raw/10.5.8/docs/examples/backupconfiguration.yaml
backupconfiguration.stash.appscode.com/sample-mariadb-backup created
</code></pre></div><h4 id=verify-cronjob>Verify CronJob</h4><p>If everything goes well, Stash will create a CronJob with the schedule specified in <code>spec.schedule</code> field of <code>BackupConfiguration</code> object.</p><p>Verify that the CronJob has been created using the following command,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get cronjob -n demo
NAME                                 SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
stash-backup-sample-mariadb-backup   */5 * * * *   False     <span style=color:#ae81ff>0</span>        15s             17s
</code></pre></div><h4 id=wait-for-backupsession>Wait for BackupSession</h4><p>The <code>sample-mariadb-backup</code> CronJob will trigger a backup on each scheduled slot by creating a <code>BackupSession</code> object.</p><p>Now, wait for a schedule to appear. Run the following command to watch for a <code>BackupSession</code> object,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get backupsession -n demo -w
NAME                               INVOKER-TYPE          INVOKER-NAME            PHASE     AGE
sample-mariadb-backup-1606994706   BackupConfiguration   sample-mariadb-backup   Running   24s
sample-mariadb-backup-1606994706   BackupConfiguration   sample-mariadb-backup   Running   75s
sample-mariadb-backup-1606994706   BackupConfiguration   sample-mariadb-backup   Succeeded   103s
</code></pre></div><p>Here, the phase <code>Succeeded</code> means that the backup process has been completed successfully.</p><h4 id=verify-backup>Verify Backup</h4><p>Now, we are going to verify whether the backed up data is present in the backend or not. Once a backup is completed, Stash will update the respective <code>Repository</code> object to reflect the backup completion. Check that the repository <code>gcs-repo</code> has been updated by the following command,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get repository -n demo gcs-repo
NAME       INTEGRITY   SIZE        SNAPSHOT-COUNT   LAST-SUCCESSFUL-BACKUP   AGE
gcs-repo   true        1.327 MiB   <span style=color:#ae81ff>1</span>                60s                      8m
</code></pre></div><p>Now, if we navigate to the GCS bucket, we will see the backed up data has been stored in <code>demo/mariadb/sample-mariadb</code> directory as specified by <code>.spec.backend.gcs.prefix</code> field of the <code>Repository</code> object.</p><figure align=center><img alt="Backup data in GCS Bucket" src=./images/sample-mariadb-backup.png><figcaption align=center>Fig: Backup data in GCS Bucket</figcaption></figure><blockquote><p>Note: Stash keeps all the backed up data encrypted. So, data in the backend will not make any sense until they are decrypted.</p></blockquote><h2 id=restore-mariadb>Restore MariaDB</h2><p>If you have followed the previous sections properly, you should have a successful logical backup of your MariaDB database. Now, we are going to show how you can restore the database from the backed up data.</p><h3 id=restore-into-the-same-database>Restore Into the Same Database</h3><p>You can restore your data into the same database you have backed up from or into a different database in the same cluster or a different cluster. In this section, we are going to show you how to restore in the same database which may be necessary when you have accidentally deleted any data from the running database.</p><h4 id=temporarily-pause-backup>Temporarily Pause Backup</h4><p>At first, let&rsquo;s stop taking any further backup of the database so that no backup runs after we delete the sample data. We are going to pause the <code>BackupConfiguration</code> object. Stash will stop taking any further backup when the <code>BackupConfiguration</code> is paused.</p><p>Let&rsquo;s pause the <code>sample-mariadb-backup</code> BackupConfiguration,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl patch backupconfiguration -n demo sample-mariadb-backup --type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;merge&#34;</span> --patch<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{&#34;spec&#34;: {&#34;paused&#34;: true}}&#39;</span>
backupconfiguration.stash.appscode.com/sample-mariadb-backup patched
</code></pre></div><p>Verify that the <code>BackupConfiguration</code> has been paused,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get backupconfiguration -n demo sample-mariadb-backup
NAME                 TASK                  SCHEDULE      PAUSED   AGE
sample-mariadb-backup  mariadb-backup-10.5.8   */5 * * * *   true     26m
</code></pre></div><p>Notice the <code>PAUSED</code> column. Value <code>true</code> for this field means that the <code>BackupConfiguration</code> has been paused.</p><p>Stash will also suspend the respective CronJob.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get cronjob -n demo
NAME                                 SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
stash-backup-sample-mariadb-backup   */5 * * * *   True      <span style=color:#ae81ff>0</span>        2m59s           20m
</code></pre></div><h4 id=simulate-disaster>Simulate Disaster</h4><p>Now, let&rsquo;s simulate an accidental deletion scenario. Here, we are going to exec into the database pod and delete the <code>company</code> database we had created earlier.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl exec -it -n demo sample-mariadb-0 -- mariadb --user<span style=color:#f92672>=</span>$USER_NAME --password<span style=color:#f92672>=</span>$PASSWORD

<span style=color:#75715e># View current databases</span>
MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| company            |
| information_schema |
| my_database        |
| mysql              |
| performance_schema |
| test               |
+--------------------+
<span style=color:#ae81ff>6</span> rows in set <span style=color:#f92672>(</span>0.001 sec<span style=color:#f92672>)</span>

<span style=color:#75715e># Let&#39;s delete the &#34;company&#34; database</span>
MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; drop database company;
Query OK, <span style=color:#ae81ff>1</span> row affected <span style=color:#f92672>(</span>0.268 sec<span style=color:#f92672>)</span>

<span style=color:#75715e># Verify that the &#34;company&#34; database has been deleted</span>
MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| my_database        |
| mysql              |
| performance_schema |
| test               |
+--------------------+
<span style=color:#ae81ff>5</span> rows in set <span style=color:#f92672>(</span>0.001 sec<span style=color:#f92672>)</span>

MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; exit
Bye
</code></pre></div><h4 id=create-restoresession>Create RestoreSession</h4><p>To restore the database, you have to create a <code>RestoreSession</code> object pointing to the <code>AppBinding</code> of the targeted database.</p><p>Here, is the YAML of the <code>RestoreSession</code> object that we are going to use for restoring our <code>sample-mariadb</code> database.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>stash.appscode.com/v1beta1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>RestoreSession</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample-mariadb-restore</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>demo</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>task</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mariadb-restore-10.5.8</span>
  <span style=color:#f92672>repository</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gcs-repo</span>
  <span style=color:#f92672>target</span>:
    <span style=color:#f92672>ref</span>:
      <span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>appcatalog.appscode.com/v1alpha1</span>
      <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>AppBinding</span>
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample-mariadb</span>
  <span style=color:#f92672>rules</span>:
  - <span style=color:#f92672>snapshots</span>: [<span style=color:#ae81ff>latest]</span>
</code></pre></div><p>Here,</p><ul><li><code>.spec.task.name</code> specifies the name of the Task object that specifies the necessary Functions and their execution order to restore a MariaDB database.</li><li><code>.spec.repository.name</code> specifies the Repository object that holds the backend information where our backed up data has been stored.</li><li><code>.spec.target.ref</code> refers to the respective AppBinding of the <code>sample-mariadb</code> database.</li><li><code>.spec.rules</code> specifies that we are restoring data from the latest backup snapshot of the database.</li></ul><p>Let&rsquo;s create the <code>RestoreSession</code> object object we have shown above,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl apply -f https://github.com/stashed/mariadb/raw/10.5.8/docs/helm/examples/restoresession.yaml
restoresession.stash.appscode.com/sample-mariadb-restore created
</code></pre></div><p>Once, you have created the <code>RestoreSession</code> object, Stash will create a restore Job. Run the following command to watch the phase of the <code>RestoreSession</code> object,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get restoresession -n demo -w
NAME                     REPOSITORY   PHASE     AGE
sample-mariadb-restore   gcs-repo     Running   15s
sample-mariadb-restore   gcs-repo     Succeeded   18s
</code></pre></div><p>The <code>Succeeded</code> phase means that the restore process has been completed successfully.</p><h4 id=verify-restored-data>Verify Restored Data</h4><p>Now, let&rsquo;s exec into the database pod and verify whether data actual data was restored or not,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl exec -it -n demo sample-mariadb-0 -- mariadb --user<span style=color:#f92672>=</span>$USER_NAME --password<span style=color:#f92672>=</span>$PASSWORD

<span style=color:#75715e># Verify that the &#34;company&#34; database has been restored</span>
MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| company            |
| information_schema |
| my_database        |
| mysql              |
| performance_schema |
| test               |
+--------------------+
<span style=color:#ae81ff>6</span> rows in set <span style=color:#f92672>(</span>0.000 sec<span style=color:#f92672>)</span>

<span style=color:#75715e># Verify that the tables of the &#34;company&#34; database have been restored</span>
MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; show tables from company;
+-------------------+
| Tables_in_company |
+-------------------+
| employees         |
+-------------------+
<span style=color:#ae81ff>1</span> row in set <span style=color:#f92672>(</span>0.000 sec<span style=color:#f92672>)</span>

<span style=color:#75715e># Verify that the sample data of the &#34;employees&#34; table has been restored</span>
MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; <span style=color:#66d9ef>select</span> * from company.employees;
+---------------+--------+
| name          | salary |
+---------------+--------+
| John Doe      |   <span style=color:#ae81ff>5000</span> |
| James William |   <span style=color:#ae81ff>7000</span> |
+---------------+--------+
<span style=color:#ae81ff>2</span> rows in set <span style=color:#f92672>(</span>0.000 sec<span style=color:#f92672>)</span>

MariaDB <span style=color:#f92672>[(</span>none<span style=color:#f92672>)]</span>&gt; exit
Bye
</code></pre></div><p>Hence, we can see from the above output that the deleted data has been restored successfully from the backup.</p><h4 id=resume-backup>Resume Backup</h4><p>Since our data has been restored successfully we can now resume our usual backup process. Resume the <code>BackupConfiguration</code> using following command,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl patch backupconfiguration -n demo sample-mariadb-backup --type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;merge&#34;</span> --patch<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{&#34;spec&#34;: {&#34;paused&#34;: false}}&#39;</span>
backupconfiguration.stash.appscode.com/sample-mariadb-backup patched
</code></pre></div><p>Verify that the <code>BackupConfiguration</code> has been resumed,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get backupconfiguration -n demo sample-mariadb-backup
NAME                    TASK                         SCHEDULE      PAUSED   AGE
sample-mariadb-backup   mariadb-backup-10.5.8   */5 * * * *   false    29m
</code></pre></div><p>Here, <code>false</code> in the <code>PAUSED</code> column means the backup has been resume successfully. The CronJob also should be resumed now.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get cronjob -n demo
NAME                                 SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
stash-backup-sample-mariadb-backup   */5 * * * *   False     <span style=color:#ae81ff>0</span>        2m59s           29m
</code></pre></div><p>Here, <code>False</code> in the <code>SUSPEND</code> column means the CronJob is no longer suspended and will trigger in the next schedule.</p><h3 id=restore-into-different-database-of-the-same-namespace>Restore Into Different Database of the Same Namespace</h3><p>If you want to restore the backed up data into a different database of the same namespace, you have to create another <code>AppBinding</code> pointing to the desired database. Then, you have to create the <code>RestoreSession</code> pointing to the new <code>AppBinding</code>.</p><h3 id=restore-into-different-namespace>Restore Into Different Namespace</h3><p>If you want to restore into a different namespace of the same cluster, you have to create the Repository, backend Secret, AppBinding, in the desired namespace. You can use <a href=https://stash.run/docs/v2020.11.17/guides/latest/cli/cli/>Stash kubectl plugin</a> to easily copy the resources into a new namespace. Then, you have to create the <code>RestoreSession</code> object in the desired namespace pointing to the Repository, AppBinding of that namespace.</p><h3 id=restore-into-different-cluster>Restore Into Different Cluster</h3><p>If you want to restore into a different cluster, you have to install Stash in the desired cluster. Then, you have to install Stash MariaDB addon in that cluster too. Then, you have to create the Repository, backend Secret, AppBinding, in the desired cluster. Finally, you have to create the <code>RestoreSession</code> object in the desired cluster pointing to the Repository, AppBinding of that cluster.</p><h2 id=cleanup>Cleanup</h2><p>To cleanup the Kubernetes resources created by this tutorial, run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete -n demo backupconfiguration sample-mariadb-backup
kubectl delete -n demo restoresession sample-mariadb-restore
kubectl delete -n demo repository gcs-repo
<span style=color:#75715e># delete the database chart</span>
helm delete sample-mariadb -n demo
</code></pre></div></div></div><div class="column is-2"><div class=right-sidebar-area><div class=search-area><form action=#><input id=acSearch type=text placeholder=Search...>
<button class=search-button>
<i class="fa fa-search" aria-hidden=true></i></button></form></div><div class=tbl-of-contents><h4>What's on this Page</h4><nav id=TableOfContents><ul><li><a href=#before-you-begin>Before You Begin</a></li><li><a href=#prepare-mariadb>Prepare MariaDB</a><ul><li><a href=#deploy-mariadb>Deploy MariaDB</a></li><li><a href=#insert-sample-data>Insert Sample Data</a></li></ul></li><li><a href=#prepare-for-backup>Prepare for Backup</a><ul><li><a href=#ensure-mariadb-addon>Ensure MariaDB Addon</a></li><li><a href=#create-appbinding>Create AppBinding</a></li><li><a href=#prepare-backend>Prepare Backend</a></li><li><a href=#backup>Backup</a></li></ul></li><li><a href=#restore-mariadb>Restore MariaDB</a><ul><li><a href=#restore-into-the-same-database>Restore Into the Same Database</a></li><li><a href=#restore-into-different-database-of-the-same-namespace>Restore Into Different Database of the Same Namespace</a></li><li><a href=#restore-into-different-namespace>Restore Into Different Namespace</a></li><li><a href=#restore-into-different-cluster>Restore Into Different Cluster</a></li></ul></li><li><a href=#cleanup>Cleanup</a></li></ul></nav></div></div></div></div></div><script>var kdDropdown=document.querySelector(".dropdown");var kdDropdownBtn=document.querySelector(".dropdown-trigger");kdDropdownBtn.addEventListener("click",function(){kdDropdown.classList.toggle("is-active");})</script></div><div class=overlay-bg></div><div class=sidebar-search-area><div class=search-area-top><h3>Search</h3><div class=searchbar-area><input type=search name=search id=searchbox placeholder=Search...>
<button onclick=queryPage(1)><i class="fa fa-search" aria-hidden=true></i></button></div><span id=searchbar-script-container style=display:none></span><div class="search-meta-information level"><div class=level-left></div></div></div><div class=search-result-wrapper></div><div class=pagination-area><div class=pagination-list></div></div></div><div class=improve-section-area><div class="container section"><div class=improve-bg-color><div class=columns><div class="column is-6"><a href=https://github.com/stashed/docs/edit/master/docs/addons/mariadb/guides/10.5.8/helm/logical.md/>Improve This Page</a></div></div></div></div></div><script type=text/javascript>var pageSize=5;var acSearch=document.querySelector("#acSearch");var bodyOverlay=document.querySelector(".overlay-bg");var sidebarSearch=document.querySelector(".sidebar-search-area");acSearch.addEventListener("click",function(){bodyOverlay.style.display="block";sidebarSearch.style.right="0";document.getElementById("searchbox").focus();bodyOverlay.addEventListener("click",function(){bodyOverlay.style.display="none";sidebarSearch.style.right="-80%";});});function encodeQueryData(data){var ret=[];for(var d in data)
ret.push(encodeURIComponent(d)+'='+encodeURIComponent(data[d]));return ret.join('&');}
document.querySelector(".searchbar-area input[type=search]").addEventListener("keyup",function(event){event.preventDefault();if(event.keyCode===13){queryPage(1);}});function queryPage(idx){var q=document.getElementById("searchbox").value;var cx="015199383701854252104:0pfqfvpvwyl";var key="AIzaSyBo15AW3hatf4fO8actJUZ_d5qZJpx0rXM";var imgSize="small";var callback="renderResult";var src="https://www.googleapis.com/customsearch/v1?"+encodeQueryData({q:q,cx:cx,key:key,imgSize:imgSize,callback:callback,start:(idx-1)*pageSize+1,num:pageSize,});var newScript=document.createElement("script");newScript.src=src;e=document.getElementById("searchbar-script-container");var child=e.lastElementChild;if(child){e.removeChild(child);}
e.appendChild(newScript);}
function renderSearchResultEntry(e){var out='<div class="single-search-result">'+
'<h3><a href="'+e.link+'">'+e.title+'</a></h3>'+
'<a href="'+e.link+'">'+e.htmlFormattedUrl+'</a>'+
'<div class="result-description-wrapper">';if(e.pagemap&&e.pagemap.cse_thumbnail){out+='<div class="result-thumb">'+
'<img src="'+e.pagemap.cse_thumbnail[0].src+'" alt="" />'+
'</div>';}
out+='<div class="result-description">'+
'<p>'+
e.snippet+
'</p>'+
'</div>'+
'</div>'+
'</div>';return out;}
function renderResult(response){document.querySelector(".search-meta-information .level-left").innerHTML='<div class="level-left">'+
'<p>'+
'About <span class="search-count">'+response.searchInformation.formattedTotalResults+'</span> results (<span class="time-count">'+response.searchInformation.formattedSearchTime+' </span>seconds)'+
'</p>'+
'</div>';if(!response.items){return;}
var searchResultWrapper=document.querySelector(".search-result-wrapper");searchResultWrapper.innerHTML="";for(var i=0;i<response.items.length;i++){searchResultWrapper.innerHTML+=renderSearchResultEntry(response.items[i]);}
var pager='<ul>';if(response.queries.previousPage){var pageIndex=Math.floor(response.queries.previousPage[0].startIndex/pageSize)+1;pager+='<li><a href="#" onclick="queryPage('+pageIndex+')">Previous</a></li>';}
if(response.queries.request){var pageIndex=Math.floor(response.queries.request[0].startIndex/pageSize)+1;pager+='<li><a href="#" onclick="queryPage('+pageIndex+')" class="is-active">'+pageIndex+'</a></li>';}
if(response.queries.nextPage){var pageIndex=Math.floor(response.queries.nextPage[0].startIndex/pageSize)+1;pager+='<li><a href="#" onclick="queryPage('+pageIndex+')">Next</a></li>';}
pager+='</ul>';document.querySelector(".pagination-area .pagination-list").innerHTML=pager;}</script><section></section><section></section><section></section><button class=go-to-top id=goTop>
<i class="fa fa-angle-up" aria-hidden=true></i></button><footer class=footer-area><div class=footer-top><div class="container section"><div class="columns is-mobile is-multiline"><div class="column is-full-mobile is-one-third-desktop is-one-third-widescreen is-one-third-tablet" data-aos=fade-up><div class=single-footer-widget><div class=footer-logo><a href=https://appscode.com><img src=/assets/images/products/appscode/appscode.png alt=AppsCode class=img></a></div><div class=subscription-form><form action="https://appscode.us17.list-manage.com/subscribe/post?u=feb2bf31969a951e7449048a3&id=82fb19acb9" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=navbar-form target=_blank novalidate role=email role=email><label for=email>Subscribe to Our Newsletter</label><p class=spam-message>No spam, we promise. Your mail address is secure</p><div class="field has-addons"><div class=control><input class=input name=EMAIL id=mce-EMAIL type=email placeholder="Your work email address" required>
<button id=mc-embedded-subscribe type=submit name=subscribe class=button>
<i class="fa fa-paper-plane-o" aria-hidden=true></i></button></div></div></form></div><div class=contact-information><h4>Have any Inquiry?</h4><ul class=all-contact-info><li><a href=callto:+1%28650%29241-8486><span><i class="fa fa-phone" aria-hidden=true></i></span>+1(650)241-8486</a></li><li><a href=mailto:support@appscode.com><span><i class="fa fa-envelope-o" aria-hidden=true></i></span>support@appscode.com</a></li></ul></div></div></div><div class="column is-half-mobile" data-aos=fade-up data-aos-duration=500><div class=single-footer-widget><div class=footer-menu><h4>Products</h4><ul class=footer-link><li><a href=https://kubedb.com>KubeDB</a></li><li><a href=https://stash.run>Stash</a></li><li><a href=https://kubevault.com>KubeVault</a></li><li><a href=https://kubeform.com>Kubeform</a></li></ul></div></div></div><div class="column is-half-mobile" data-aos=fade-up data-aos-duration=600><div class=single-footer-widget><div class=footer-menu><h4>Services</h4><ul class=footer-link><li><a href=https://appscode.com/pricing/>Pricing</a></li><li><a href=https://appscode.com/consulting/>Consulting</a></li><li><a href=https://appscode.com/training/>Training</a></li><li><a href=https://appscode.com/support/>Support</a></li></ul></div></div></div><div class="column is-half-mobile" data-aos=fade-up data-aos-duration=700><div class=single-footer-widget><div class=footer-menu><h4>Company</h4><ul class=footer-link><li><a href=https://appscode.com/about/>About Us</a></li><li><a href=https://blog.byte.builders>Blog</a></li><li><a href=https://appscode.com/contact/>Contact Us</a></li></ul></div></div></div><div class="column is-half-mobile" data-aos=fade-up data-aos-duration=800><div class=single-footer-widget><div class=footer-menu><h4>Legal</h4><ul class=footer-link><li><a href=https://appscode.com/legal/tos/>Terms of Sevice</a></li><li><a href=https://appscode.com/legal/privacy-policy/>Privacy Policy</a></li><li><a href=https://appscode.com/legal/security/>Security</a></li><li><a href=https://appscode.com/legal/sla/>Service Level Agreement</a></li></ul></div></div></div></div></div></div><div class=footer-bottom><div class="container section"><div class=columns><div class="column is-4"><p> 2021 AppsCode Inc. All rights reserved.</p></div><div class="column is-4 is-mobile has-text-centered"><div class=footer-inline-link><a href=https://appscode.com/legal/privacy-policy/>Privacy Policy</a>
<a href=https://appscode.com/legal/tos/>Terms of Service</a></div></div><div class="column is-4 is-mobile has-text-right"><div class=socail-link-inline><ul><li><a href=https://twitter.com/AppsCodeHQ><i class="fa fa-twitter" aria-hidden=true></i></a></li><li><a href=https://www.facebook.com/appscode><i class="fa fa-facebook" aria-hidden=true></i></a></li><li><a href=https://www.youtube.com/c/AppsCodeInc><i class="fa fa-youtube" aria-hidden=true></i></a></li></ul></div></div></div></div></div></footer><script src=/assets/js/bulma-carousel.min.js></script><script src=https://unpkg.com/aos@2.3.1/dist/aos.js></script><script src=https://unpkg.com/downloadjs@1.4.7/download.min.js></script><script src=https://unpkg.com/clipboard@2/dist/clipboard.min.js></script><script src=/assets/js/main.js></script><script type=text/javascript>var Tawk_API=Tawk_API||{},Tawk_LoadStart=new Date();(function(){var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];s1.async=true;s1.src='https://embed.tawk.to/5821e34b18d9f16af02864b7/default';s1.charset='UTF-8';s1.setAttribute('crossorigin','*');s0.parentNode.insertBefore(s1,s0);})();</script></body></html>