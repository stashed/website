<!doctype html><html lang=en><head><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-62096468-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#5E2DEA"><title>Stash by AppsCode</title><meta name=description content="Stash by AppsCode is a cloud native data backup and recovery solution for Kubernetes workloads, volumes and databases"><meta name=author content="AppsCode Inc."><meta name=keywords content="kubernetes appscode backup disaster recovery volume"><link rel=apple-touch-icon sizes=57x57 href=/assets/images/products/stash/icons/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/assets/images/products/stash/icons/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/assets/images/products/stash/icons/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/assets/images/products/stash/icons/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/assets/images/products/stash/icons/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/assets/images/products/stash/icons/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/assets/images/products/stash/icons/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/assets/images/products/stash/icons/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/assets/images/products/stash/icons/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/assets/images/products/stash/icons/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/assets/images/products/stash/icons/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/assets/images/products/stash/icons/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/assets/images/products/stash/icons/favicon-16x16.png><link rel=manifest href=/assets/images/products/stash/icons/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/assets/images/products/stash/icons/ms-icon-144x144.png"><meta itemprop=name content="Stash by AppsCode"><meta itemprop=description content="Stash by AppsCode is a cloud native data backup and recovery solution for Kubernetes workloads, volumes and databases"><meta itemprop=image content="https://stash.run/assets/images/products/stash/stash-1280x640.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@KubeStash"><meta name=twitter:title content="Stash by AppsCode"><meta name=twitter:creator content="@KubeStash"><meta name=twitter:description content="Stash by AppsCode is a cloud native data backup and recovery solution for Kubernetes workloads, volumes and databases"><meta name=twitter:image:src content="https://stash.run/assets/images/products/stash/stash-1280x640.png"><meta property="og:url" content="https://stash.run"><meta property="og:title" content="Stash by AppsCode"><meta property="og:description" content="Stash by AppsCode is a cloud native data backup and recovery solution for Kubernetes workloads, volumes and databases"><meta property="og:site_name" content="Stash by AppsCode"><meta property="og:image" content="https://stash.run/assets/images/products/stash/stash-1280x640.png"><meta property="og:type" content="article"><link rel=stylesheet href=/assets/css/font-awesome.min.css><link href=https://unpkg.com/aos@2.3.1/dist/aos.css rel=stylesheet><link rel=stylesheet href=/assets/css/bulma-carousel.min.css><link rel=stylesheet href=/assets/css/bulma-tooltip.min.css><link rel=stylesheet href=/assets/css/bulma.min.css><link rel=stylesheet href=/assets/sass/main.min.07c98ba8010cf282fb1bc78228ba008ded77cf1eec07444d29c1e8c784afee49.css></head><body class=stash><header><div class=header-top><div class="container section"><nav class=navbar><div class=navbar-brand><a class=navbar-item href=https://appscode.com><img src=/assets/images/products/appscode/appscode.png alt=AppsCode></a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=acNav1><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div id=acNav1 class="navbar-menu main-menu"><div class=navbar-end><div class=navbar-start><div class="navbar-item has-dropdown ac-is-hoverable"><a class=navbar-link>Products</a><div class=ac-megamenu><div class=columns><div class="column is-8"><div class=columns><div class="column is-6 br-1"><a href=https://kubedb.com class="single-product-item is-kubedb"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/kubedb/kubedb-icon.png alt=KubeDB></div><h5>KubeDB</h5></div><div class=menu-body><p>Run production-grade databases easily on Kubernetes</p></div></a><a href=https://stash.run class="single-product-item is-stash"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/stash/stash-icon.png alt=Stash></div><h5>Stash</h5></div><div class=menu-body><p>Backup your Kubernetes Stateful Applications</p></div></a><a href=https://kubevault.com class="single-product-item is-kubevault"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/kubevault/kubevault-icon.png alt=KubeVault></div><h5>KubeVault</h5></div><div class=menu-body><p>Tools for running HashiCorp Vault on Kubernetes</p></div></a><a href=https://appscode.com/products/guard/ class="single-product-item is-guard"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/guard/guard-icon.png alt=Guard></div><h5>Guard</h5></div><div class=menu-body><p>Kubernetes Authentication WebHook Server</p></div></a></div><div class="column is-6 br-1"><a href class="single-product-item is-voyager"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/voyager/voyager-icon.png alt=Voyager></div><h5>Voyager</h5></div><div class=menu-body><p>Secure HAProxy Ingress Controller for
Kubernetes</p></div></a><a href=https://appscode.com/products/swift/ class="single-product-item is-swift"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/swift/swift-icon.png alt=Swift></div><h5>Swift</h5></div><div class=menu-body><p>Ajax friendly Helm Tiller Proxy</p></div></a><a href=https://appscode.com/products/searchlight/ class="single-product-item is-searchlight"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/searchlight/searchlight-icon.png alt=Searchlight></div><h5>Searchlight</h5></div><div class=menu-body><p>Alerts for Kubernetes</p></div></a><a href=https://appscode.com/products/kubed/ class="single-product-item is-kubed"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/kubed/kubed-icon.png alt=Kubed></div><h5>Kubed</h5></div><div class=menu-body><p>Kubernetes cluster manager daemon</p></div></a></div></div></div><div class="column is-4"><div class=columns><div class="column is-12"><a href=https://byte.builders class="single-product-item byte-builder kd-orange"><div class=menu-header><p class=intro>Introducing....</p><h5>ByteBuilders</h5></div><div class=menu-body><p>Cloud reimagined for the age of Kubernetes</p></div><p class=learn-more-btn>Learn more
<span class=icon><i class="fa fa-long-arrow-right" aria-hidden=true></i></span></p></a><a href=https://pharmer.io class="single-product-item is-pharmer"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/pharmer/pharmer-icon.png alt=Pharmer></div><h5>Pharmer</h5></div><div class=menu-body><p>Kubernetes Cluster Manager using Kubeadm & Cluster API</p></div></a><a href=https://kubeform.com class="single-product-item is-kubeform"><div class=menu-header><div class=menu-logo><img src=/assets/images/products/kubeform/kubeform-icon.png alt=Kubeform></div><h5>Kubeform</h5></div><div class=menu-body><p>Provision cloud resources using Kubernetes CRDs & Terraform</p></div></a></div></div></div></div><div class="columns has-text-centered"><div class=column><div class=menu-bottom><p>Explore apps and integrations for AppsCode products:
<a href=https://marketplace.byte.builders>Visit the Marketplace
<i class="fa fa-long-arrow-right" aria-hidden=true></i></a></p></div></div></div></div></div><div class="navbar-item has-dropdown ac-is-hoverable"><a class=navbar-link>Services</a><div class=ac-dropdown><a class=navbar-item href=https://appscode.com/consulting/>Consulting</a>
<a class=navbar-item href=https://appscode.com/training/>Training</a>
<a class=navbar-item href=https://appscode.com/support/>Support</a></div></div><a class=navbar-item href=https://blog.byte.builders>Blog</a>
<a class=navbar-item href=https://appscode.com/contact/>Contact Us</a></div><div class=navbar-item><div class="buttons main-menu-button-top"><a class="button is-small for-chat" href=https://slack.appscode.com><span><img src=/assets/images/icon/slack.png alt></span>Slack</a>
<a class="button is-small for-support" href=https://appscode.freshdesk.com><span><img src=/assets/images/icon/chat.png alt></span>Support Portal</a></div></div></div></div></nav></div></div><div class="header-bottom-area header-area kubedb-primary-bg customize-kubedb fixed-menu"><div class="container section"><nav class=navbar><div class=navbar-brand><a class=navbar-item href=https://stash.run><img src=/assets/images/products/stash/stash-white.png alt=Stash></a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=acNav><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div id=acNav class="navbar-menu main-menu"><div class=navbar-end><div class=navbar-start><a href=/features/ class=navbar-item>Features</a>
<a href=/pricing/ class=navbar-item>Pricing</a>
<a href=/docs/v2020.08.27/welcome/ class=navbar-item>Documentation</a><div class="navbar-item has-dropdown ac-is-hoverable"><a class=navbar-link>Community</a><div class=ac-dropdown><a href=https://github.com/stashed class=navbar-item>GitHub</a>
<a href=https://twitter.com/KubeStash class=navbar-item>Twitter</a>
<a href=https://slack.appscode.com class=navbar-item>Slack</a></div></div></div><div class=navbar-item><div class="buttons main-menu-button"><img style=height:24px alt="GitHub Stars" src="https://img.shields.io/github/stars/appscode/stash?style=flat&labelColor=1B3D4B&color=06A64F&logoColor=white&logo=github">
&nbsp;&nbsp;&nbsp;
<img style=height:24px alt="Docker Pulls" src="https://img.shields.io/docker/pulls/appscode/stash?style=flat&labelColor=1B3D4B&color=06A64F&logoColor=white&logo=docker"></div></div></div></div></nav></div></div><div class=documentation-menu><div class="container section"><div class=is-centered><div class="is-half has-text-centered-desktop"><div class=responsive-menu><a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=acNav3><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><nav class=documentation-navbar><div id=acNav3 class="navbar-menu nav-menu main-menu"><div class=navbar-centered><div class=navbar-start><a href=/docs/v2020.08.27-rc.0/ class=navbar-item>Welcome</a>
<a href=/docs/v2020.08.27-rc.0/concepts/ class=navbar-item>Concepts</a>
<a href=/docs/v2020.08.27-rc.0/setup/ class=navbar-item>Setup</a><div class="navbar-item has-dropdown ac-is-hoverable"><a class=navbar-link>Guides</a><div class=ac-dropdown><a href=/docs/v2020.08.27-rc.0/guides/latest/ class=navbar-item>Latest Guides</a>
<a href=/docs/v2020.08.27-rc.0/guides/v1alpha1/ class=navbar-item>v1alpha1 Guides</a></div></div><div class="navbar-item has-dropdown ac-is-hoverable"><a class=navbar-link>Addons</a><div class=ac-dropdown><a href=/docs/v2020.08.27-rc.0/addons/postgres/ class=navbar-item>Postgres</a>
<a href=/docs/v2020.08.27-rc.0/addons/elasticsearch/ class=navbar-item>Elasticsearch</a>
<a href=/docs/v2020.08.27-rc.0/addons/mysql/ class=navbar-item>MySQL</a>
<a href=/docs/v2020.08.27-rc.0/addons/mongodb/ class=navbar-item>MongoDB</a>
<a href=/docs/v2020.08.27-rc.0/addons/percona-xtradb/ class=navbar-item>Percona XtraDB</a></div></div><div class="navbar-item has-dropdown ac-is-hoverable"><a class=navbar-link>Reference</a><div class=ac-dropdown><a href=/docs/v2020.08.27-rc.0/reference/operator/ class=navbar-item>Stash Operator</a>
<a href=/docs/v2020.08.27-rc.0/reference/cli/ class=navbar-item>Stash CLI</a></div></div></div></div></div></nav></div></div></div></div></header><div class=documentation-area><div class="container section"><div class=columns><div class="column is-3"><div class=kd-left-sidebar><div class=trial-button><a href=/docs/v2020.08.27/setup/ class="button is-fullwidth">Try Now for FREE!</a></div><div class=kd-version><div class=dropdown><div class=dropdown-trigger><button class="button is-fullwidth" aria-haspopup=true aria-controls=dropdown-menu3>
<span class="icon is-small"><i class="fa fa-angle-down" aria-hidden=true></i></span></button></div><div class=dropdown-menu id=dropdown-menu3 role=menu><div class=dropdown-content><a href=https://github.com/stashed/docs/tree/master/docs target=_blank class=dropdown-item>master</a>
<a href=/docs/v2020.08.27/ class=dropdown-item>v2020.08.27<div class=tag>Latest</div></a><a href=/docs/v0.9.0-rc.6/ class=dropdown-item>v0.9.0-rc.6</a>
<a href=/docs/0.8.3/ class=dropdown-item>0.8.3</a>
<a href=/docs/0.8.2/ class=dropdown-item>0.8.2</a>
<a href=/docs/0.8.1/ class=dropdown-item>0.8.1</a>
<a href=/docs/0.8.0/ class=dropdown-item>0.8.0</a>
<a href=/docs/0.7.0/ class=dropdown-item>0.7.0</a>
<a href=/docs/0.6.4/ class=dropdown-item>0.6.4</a>
<a href=https://github.com/stashed/docs/tree/0.4.2/docs target=_blank class=dropdown-item>0.4.2</a></div></div></div></div><div class=kd-sidebar-menu><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-1>
<label for=422fb6da068b7b47ffec5253c6c93500-1><a href=/docs/v2020.08.27-rc.0/guides/latest/>Latest Guides</a></label></div><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-2>
<label for=422fb6da068b7b47ffec5253c6c93500-2><a>Supported Backends</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.08.27-rc.0/guides/latest/backends/overview/>What is Backend?</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/backends/local/>Kubernetes Volumes</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/backends/s3/>AWS S3/Minio/Rook</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/backends/azure/>Azure Blob Storage</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/backends/gcs/>Google Cloud Storage</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/backends/swift/>OpenStack Swift</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/backends/b2/>Backblaze B2</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/backends/rest/>REST Server</a></li></ul></div></div><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-3>
<label for=422fb6da068b7b47ffec5253c6c93500-3><a>Workload's Volumes</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.08.27-rc.0/guides/latest/workloads/overview/>How Backup and Restore works?</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/workloads/deployment/>Backup & Restore Volumes of a Deployment</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/workloads/statefulset/>Backup & Restore Volumes of a StatefulSet</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/workloads/daemonset/>Backup & Restore Volumes of a DaemonSet</a></li></ul></div></div><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-4>
<label for=422fb6da068b7b47ffec5253c6c93500-4><a>Stand-alone Volumes</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.08.27-rc.0/guides/latest/volumes/overview/>How does it work?</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/volumes/pvc/>Backup & Restore a Stand-alone PVC</a></li></ul></div></div><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-5>
<label for=422fb6da068b7b47ffec5253c6c93500-5><a>Batch Backup</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.08.27-rc.0/guides/latest/batch-backup/overview/>How Batch Backup & Restore works?</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/batch-backup/batch-backup/>Backup a WordPress Site</a></li></ul></div></div><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-6>
<label for=422fb6da068b7b47ffec5253c6c93500-6><a>Auto Backup</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.08.27-rc.0/guides/latest/auto-backup/overview/>What is Auto Backup?</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/auto-backup/workload/>Auto Backup for Workloads</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/auto-backup/pvc/>Auto Backup for PVCs</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/auto-backup/database/>Auto Backup for Databases</a></li></ul></div></div><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-7 checked>
<label for=422fb6da068b7b47ffec5253c6c93500-7><a>Volume Snapshot</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.08.27-rc.0/guides/latest/volumesnapshot/overview/>How VolumeSnapshot works?</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/volumesnapshot/deployment/>Snapshot Deployment Volumes</a></li><li class=is-active><a href=/docs/v2020.08.27-rc.0/guides/latest/volumesnapshot/statefulset/>Snapshot StatefulSet Volumes</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/volumesnapshot/pvc/>Snapshot Stand-alone PVC</a></li></ul></div></div><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-8>
<label for=422fb6da068b7b47ffec5253c6c93500-8><a>Advance Use Cases</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.08.27-rc.0/guides/latest/advanced-use-case/instant-backup/>Instant Backup</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/advanced-use-case/pause-backup/>Pause Backup</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/advanced-use-case/clone-pvc/>Clone Data Volumes</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/advanced-use-case/ownership/>File Ownership</a></li></ul></div></div><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-9>
<label for=422fb6da068b7b47ffec5253c6c93500-9><a>Platforms</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.08.27-rc.0/guides/latest/platforms/eks/>EKS</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/platforms/aks/>AKS</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/platforms/gke/>GKE</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/platforms/minio/>Minio</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/platforms/rook/>Rook</a></li></ul></div></div><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-10>
<label for=422fb6da068b7b47ffec5253c6c93500-10><a>Monitoring</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.08.27-rc.0/guides/latest/monitoring/overview/>Overview</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/monitoring/builtin/>Builtin Prometheus</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/monitoring/coreos/>Prometheus Operator</a></li></ul></div></div><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-11>
<label for=422fb6da068b7b47ffec5253c6c93500-11><a>Addons</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.08.27-rc.0/guides/latest/addons/overview/>Overview</a></li></ul></div></div><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-12>
<label for=422fb6da068b7b47ffec5253c6c93500-12><a>Hooks</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.08.27-rc.0/guides/latest/hooks/overview/>Overview</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/hooks/backup-and-restore-hooks/>Backup & Restore Hooks</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/hooks/batch-backup-hooks/>BackupBatch Hooks</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/hooks/configuring-hooks/>Configuring Hooks</a></li></ul></div></div><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-13>
<label for=422fb6da068b7b47ffec5253c6c93500-13><a>CLI</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.08.27-rc.0/guides/latest/cli/cli/>Stash kubectl Plugin</a></li></ul></div></div><div class=item><input type=checkbox id=422fb6da068b7b47ffec5253c6c93500-14>
<label for=422fb6da068b7b47ffec5253c6c93500-14><a>Security</a> <span><i class="fa fa-angle-right" aria-hidden=true></i></span></label><div class=item><ul><li><a href=/docs/v2020.08.27-rc.0/guides/latest/security/rbac/>RBAC</a></li><li><a href=/docs/v2020.08.27-rc.0/guides/latest/security/psp/>PSP</a></li></ul></div></div></div></div></div><div class="column is-7"><div class=full-info><h1 id=snapshotting-the-volumes-of-a-statefulset>Snapshotting the volumes of a StatefulSet</h1><p>This guide will show you how to use Stash to snapshot the volumes of a StatefulSets and restore them from snapshot using Kubernetes <a href=https://kubernetes.io/docs/concepts/storage/volume-snapshots/>VolumeSnapshot</a> API. In this guide, we are going to backup the volumes in Google Cloud Platform with the help of <a href=https://github.com/kubernetes-sigs/gcp-compute-persistent-disk-csi-driver>GCE Persistent Disk CSI Driver</a>.</p><h2 id=before-you-begin>Before You Begin</h2><ul><li>At first, you need to be familiar with the <a href=https://github.com/kubernetes-sigs/gcp-compute-persistent-disk-csi-driver>GCE Persistent Disk CSI Driver</a>.</li><li>You need to enable the Kubernetes <code>VolumeSnapshotDataSource</code> alpha feature via Kubernetes feature gates<ul><li><code>--feature-gates=VolumeSnapshotDataSource=true</code></li></ul></li><li>Install <code>Stash</code> in your cluster following the steps <a href=/docs/v2020.08.27-rc.0/setup/README>here</a>.</li><li>If you don&rsquo;t know how VolumeSnapshot works in Stash, please visit <a href=/docs/v2020.08.27-rc.0/guides/latest/volumesnapshot/overview>here</a>.</li></ul><h2 id=prepare-for-volumesnapshot>Prepare for VolumeSnapshot</h2><p>If you don&rsquo;t already have a StorageClass that uses the CSI driver that supports VolumeSnapshot feature, create one first. Here, we are going to create <code>StorageClass</code> that uses <a href=https://github.com/kubernetes-sigs/gcp-compute-persistent-disk-csi-driver>GCE Persistent Disk CSI Driver</a>.</p><p>Sample <code>StorageClass</code> YAML are given below,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: storage.k8s.io/v1
<span style=color:#66d9ef>kind</span>: StorageClass
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: standard
<span style=color:#66d9ef>parameters</span>:
  <span style=color:#66d9ef>type</span>: pd-standard
<span style=color:#66d9ef>provisioner</span>: pd.csi.storage.gke.io
<span style=color:#66d9ef>reclaimPolicy</span>: Delete
<span style=color:#66d9ef>volumeBindingMode</span>: Immediate
</code></pre></div><p>Let&rsquo;s create the <code>StorageClass</code> we have shown above,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl apply -f https://github.com/stashed/docs/raw/v2020.08.27-rc.0/docs/examples/guides/latest/volumesnapshot/storageclass.yaml
storageclass.storage.k8s.io/standard created
</code></pre></div><p>We also need a <code>VolumeSnapshotClass</code>. We are going to use the following <code>VolumeSnapshotClass</code> for this tutorial,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: snapshot.storage.k8s.io/v1alpha1
<span style=color:#66d9ef>kind</span>: VolumeSnapshotClass
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>annotations</span>:
    <span style=color:#66d9ef>snapshot.storage.kubernetes.io/is-default-class</span>: <span style=color:#e6db74>&#34;true&#34;</span>
  <span style=color:#66d9ef>name</span>: default-snapshot-class
<span style=color:#66d9ef>snapshotter</span>: pd.csi.storage.gke.io
</code></pre></div><p>Here,</p><ul><li><code>metadata.annotations</code> annotations are used to set default <a href=https://kubernetes.io/blog/2018/10/09/introducing-volume-snapshot-alpha-for-kubernetes/>volumeSnapshotClass</a>.</li><li><code>snapshotter</code> field to point to the respective CSI driver that is responsible for taking snapshot. As we are using <a href=https://github.com/kubernetes-sigs/gcp-compute-persistent-disk-csi-driver>GCE Persistent Disk CSI Driver</a>, we are going to set <code>pd.csi.storage.gke.io</code> to this field.</li></ul><p>Let&rsquo;s create the <code>volumeSnapshotClass</code> crd we have shown above,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl apply -f https://github.com/stashed/docs/raw/v2020.08.27-rc.0/docs/examples/guides/latest/volumesnapshot/default-volumesnapshotclass.yaml
volumesnapshotclass.snapshot.storage.k8s.io/default-snapshot-class created
</code></pre></div><p>To keep everything isolated, we are going to use a separate namespace called <code>demo</code> throughout this tutorial.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl create ns demo
namespace/demo created
</code></pre></div><blockquote><p>Note: YAML files used in this tutorial are stored in <a href=/docs/v2020.08.27-rc.0/examples/guides/latest/volumesnapshot>/docs/examples/guides/latest/volumesnapshot</a> directory of <a href=https://github.com/stashed/docs>stashed/docs</a> repository.</p></blockquote><h2 id=take-volume-snapshot>Take Volume Snapshot</h2><p>When you create a Statefulset, there is no need to create PVCs separately, because all replicas in Statefulset use different PVCs to store data. Kubernetes allows us to define a <code>volumeClaimTemplates</code> in Statefulset so that new PVC is created for each replica automatically. We are going to take snapshot of those PVCs using Stash.</p><p><strong>Deploy StatefulSet :</strong></p><p>Now, we are going to deploy a Statefulset. This Statefulset will automatically generate sample data in <code>/source/data</code> directory.</p><p>Below is the YAML of the Statefulset that we are going to create,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: v1
<span style=color:#66d9ef>kind</span>: Service
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: svc
  <span style=color:#66d9ef>labels</span>:
    <span style=color:#66d9ef>app</span>: demo
  <span style=color:#66d9ef>namespace</span>: demo
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>ports</span>:
  - <span style=color:#66d9ef>port</span>: <span style=color:#ae81ff>80</span>
    <span style=color:#66d9ef>name</span>: web
  <span style=color:#66d9ef>clusterIP</span>: None
  <span style=color:#66d9ef>selector</span>:
    <span style=color:#66d9ef>app</span>: stash
---
<span style=color:#66d9ef>apiVersion</span>: apps/v1
<span style=color:#66d9ef>kind</span>: StatefulSet
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: stash-demo
  <span style=color:#66d9ef>namespace</span>: demo
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>selector</span>:
    <span style=color:#66d9ef>matchLabels</span>:
      <span style=color:#66d9ef>app</span>: stash
  <span style=color:#66d9ef>serviceName</span>: svc
  <span style=color:#66d9ef>replicas</span>: <span style=color:#ae81ff>3</span>
  <span style=color:#66d9ef>template</span>:
    <span style=color:#66d9ef>metadata</span>:
      <span style=color:#66d9ef>labels</span>:
        <span style=color:#66d9ef>app</span>: stash
    <span style=color:#66d9ef>spec</span>:
      <span style=color:#66d9ef>containers</span>:
      - <span style=color:#66d9ef>args</span>: [<span style=color:#e6db74>&#34;echo $(POD_NAME) &gt; /source/data/data.txt &amp;&amp; sleep 3000&#34;</span>]
        <span style=color:#66d9ef>command</span>: [<span style=color:#e6db74>&#34;/bin/sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>]
        <span style=color:#66d9ef>env</span>:
        - <span style=color:#66d9ef>name</span>:  POD_NAME
          <span style=color:#66d9ef>valueFrom</span>:
            <span style=color:#66d9ef>fieldRef</span>:
              <span style=color:#66d9ef>fieldPath</span>:  metadata.name
        <span style=color:#66d9ef>name</span>: nginx
        <span style=color:#66d9ef>image</span>: nginx
        <span style=color:#66d9ef>ports</span>:
        - <span style=color:#66d9ef>containerPort</span>: <span style=color:#ae81ff>80</span>
          <span style=color:#66d9ef>name</span>: web
        <span style=color:#66d9ef>volumeMounts</span>:
        - <span style=color:#66d9ef>name</span>: source-data
          <span style=color:#66d9ef>mountPath</span>: /source/data
  <span style=color:#66d9ef>volumeClaimTemplates</span>:
  - <span style=color:#66d9ef>metadata</span>:
      <span style=color:#66d9ef>name</span>: source-data
      <span style=color:#66d9ef>namespace</span>: demo
    <span style=color:#66d9ef>spec</span>:
      <span style=color:#66d9ef>accessModes</span>:
      - ReadWriteOnce
      <span style=color:#66d9ef>storageClassName</span>: standard
      <span style=color:#66d9ef>resources</span>:
        <span style=color:#66d9ef>requests</span>:
          <span style=color:#66d9ef>storage</span>: 1Gi
</code></pre></div><p>Let&rsquo;s create the Statefulset we have shown above.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl create -f ./docs/examples/guides/latest/volumesnapshot/statefulset/statefulset.yaml
service/svc created
statefulset.apps/stash-demo created
</code></pre></div><p>Now, wait for the pod of Statefulset to go into the <code>Running</code> state.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get pod -n demo
NAME           READY   STATUS    RESTARTS   AGE
stash-demo-0   1/1     Running   <span style=color:#ae81ff>0</span>          97s
stash-demo-1   1/1     Running   <span style=color:#ae81ff>0</span>          67s
stash-demo-2   1/1     Running   <span style=color:#ae81ff>0</span>          39s
</code></pre></div><p>Let&rsquo;s find out the PVCs created for these replicas,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get pvc -n demo
NAME                       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
source-data-stash-demo-0   Bound    pvc-760c1734-a6cc-11e9-9f3a-42010a800050   1Gi        RWO            standard       70s
source-data-stash-demo-1   Bound    pvc-86f5b3bd-a6cc-11e9-9f3a-42010a800050   1Gi        RWO            standard       42s
source-data-stash-demo-2   Bound    pvc-9c9f542f-a6cc-11e9-9f3a-42010a800050   1Gi        RWO            standard       5s
</code></pre></div><p>Verify that the sample data has been created in <code>/source/data</code> directory using the following command,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl exec -n demo stash-demo-0 -- cat /source/data/data.txt
stash-demo-0
$ kubectl exec -n demo stash-demo-1 -- cat /source/data/data.txt
stash-demo-1
$ kubectl exec -n demo stash-demo-2 -- cat /source/data/data.txt
stash-demo-2
</code></pre></div><p><strong>Create BackupConfiguration :</strong></p><p>Now, create a <code>BackupConfiguration</code> crd to take snapshot of the PVCs of <code>stash-demo</code> Statefulset.</p><p>Below is the YAML of the <code>BackupConfiguration</code> that we are going to create,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: stash.appscode.com/v1beta1
<span style=color:#66d9ef>kind</span>: BackupConfiguration
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: statefulset-volume-snapshot
  <span style=color:#66d9ef>namespace</span>: demo
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>schedule</span>: <span style=color:#e6db74>&#34;*/5 * * * *&#34;</span>
  <span style=color:#66d9ef>driver</span>: VolumeSnapshotter
  <span style=color:#66d9ef>target</span>:
    <span style=color:#66d9ef>ref</span>:
      <span style=color:#66d9ef>apiVersion</span>: apps/v1
      <span style=color:#66d9ef>kind</span>: StatefulSet
      <span style=color:#66d9ef>name</span>: stash-demo
    <span style=color:#66d9ef>replicas </span>: <span style=color:#ae81ff>1</span>
    <span style=color:#66d9ef>snapshotClassName</span>: default-snapshot-class
  <span style=color:#66d9ef>retentionPolicy</span>:
    <span style=color:#66d9ef>name</span>: <span style=color:#e6db74>&#39;keep-last-5&#39;</span>
    <span style=color:#66d9ef>keepLast</span>: <span style=color:#ae81ff>5</span>
    <span style=color:#66d9ef>prune</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><p>Here,</p><ul><li><p><code>spec.schedule</code> is a <a href=https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/#schedule>cron expression</a> indicates that <code>BackupSession</code> will be created at 5 minute interval.</p></li><li><p><code>spec.driver</code> indicates the name of the agent to use to back up the target. Currently, Stash supports <code>Restic</code>, <code>VolumeSnapshotter</code> drivers. The <code>VolumeSnapshotter</code> is used to backup/restore PVC using <code>VolumeSnapshot</code> API.</p></li><li><p><code>spec.target.ref</code> refers to the backup target. <code>apiVersion</code>, <code>kind</code> and <code>name</code> refers to the <code>apiVersion</code>, <code>kind</code> and <code>name</code> of the targeted workload respectively. Stash will use this information to create a Volume Snapshotter Job for creating VolumeSnapshot.</p></li><li><p><code>spec.target.snapshotClassName</code> indicates the <a href=https://kubernetes.io/docs/concepts/storage/volume-snapshot-classes/>VolumeSnapshotClass</a> to be used for volume snapshotting.</p></li></ul><p>Let&rsquo;s create the <code>BackupConfiguration</code> crd we have shown above.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl apply -f https://github.com/stashed/docs/raw/v2020.08.27-rc.0/docs/examples/guides/latest/volumesnapshot/statefulset/backupconfiguration.yaml
backupconfiguration.stash.appscode.com/statefulset-volume-snapshot created
</code></pre></div><p><strong>Verify CronJob :</strong></p><p>If everything goes well, Stash will create a <code>CronJob</code> to take periodic snapshot of <code>stash-demo-0</code> , <code>stash-demo-1</code> and <code>stash-demo-2</code> volumes of the Statefulset with the schedule specified in <code>spec.schedule</code> field of <code>BackupConfiguration</code> crd.</p><p>Check that the <code>CronJob</code> has been created using the following command,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get cronjob -n demo
NAME                          SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
statefulset-volume-snapshot   */1 * * * *   False     <span style=color:#ae81ff>0</span>        &lt;none&gt;          18s
</code></pre></div><p><strong>Wait for BackupSession :</strong></p><p>The <code>statefulset-volume-snapshot</code> CronJob will trigger a backup on each schedule by creating a <code>BackupSession</code> crd.</p><p>Wait for the next schedule for backup. Run the following command to watch <code>BackupSession</code> crd,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ watch -n <span style=color:#ae81ff>1</span> kubectl get backupsession -n demo
Every 1.0s: kubectl get backupsession -n demo                      suaas-appscode: Tue Jun <span style=color:#ae81ff>18</span> 18:35:41 <span style=color:#ae81ff>2019</span>

NAME                                     INVOKER-TYPE          INVOKER-NAME                  PHASE       AGE
statefulset-volume-snapshot-1563177551   BackupConfiguration   statefulset-volume-snapshot   Succeeded   57s
</code></pre></div><p>We can see above that the backup session has succeeded. Now, we are going to verify that the VolumeSnapshot has been created and the snapshots has been stored in the respective backend.</p><p><strong>Verify Volume Snapshot :</strong></p><p>Once a <code>BackupSession</code> crd is created, it creates volume snapshotter <code>Job</code>. Then the <code>Job</code> creates <code>VolumeSnapshot</code> crd for the targeted PVC.The <code>VolumeSnapshot</code> name follows the following pattern:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> &lt;PVC claim name&gt;-&lt;statefulset name&gt;-&lt;pod ordinal&gt;-&lt;backup session creation timestamp in Unix epoch seconds&gt;
</code></pre></div><p>Check that the <code>VolumeSnapshot</code> has been created Successfully.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get volumesnapshot -n demo
NAME                                  AGE
source-data-stash-demo-0-1563177551   115s
source-data-stash-demo-1-1563177551   115s
source-data-stash-demo-2-1563177551   115s
</code></pre></div><p>Let&rsquo;s find out the actual snapshot name that will be saved in the Google Cloud by the following command,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get volumesnapshot source-data-stash-demo-0-1563177551 -n demo -o yaml
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: snapshot.storage.k8s.io/v1alpha1
<span style=color:#66d9ef>kind</span>: VolumeSnapshot
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>creationTimestamp</span>: <span style=color:#e6db74>&#34;2019-07-15T07:59:13Z&#34;</span>
  <span style=color:#66d9ef>finalizers</span>:
  - snapshot.storage.kubernetes.io/volumesnapshot-protection
  <span style=color:#66d9ef>generation</span>: <span style=color:#ae81ff>4</span>
  <span style=color:#66d9ef>name</span>: source-data-stash-demo<span style=color:#ae81ff>-0-1563177551</span>
  <span style=color:#66d9ef>namespace</span>: demo
  <span style=color:#66d9ef>resourceVersion</span>: <span style=color:#e6db74>&#34;18764&#34;</span>
  <span style=color:#66d9ef>selfLink</span>: /apis/snapshot.storage.k8s.io/v1alpha1/namespaces/demo/volumesnapshots/source-data-stash-demo<span style=color:#ae81ff>-0-1563177551</span>
  <span style=color:#66d9ef>uid</span>: 6f3b49a9-a6d6<span style=color:#ae81ff>-11e9</span>-9f3a-42010a800050
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>snapshotClassName</span>: default-snapshot-class
  <span style=color:#66d9ef>snapshotContentName</span>: snapcontent-6f3b49a9-a6d6<span style=color:#ae81ff>-11e9</span>-9f3a-42010a800050
  <span style=color:#66d9ef>source</span>:
    <span style=color:#66d9ef>apiGroup</span>: <span style=color:#66d9ef>null</span>
    <span style=color:#66d9ef>kind</span>: PersistentVolumeClaim
    <span style=color:#66d9ef>name</span>: source-data-stash-demo<span style=color:#ae81ff>-0</span>
<span style=color:#66d9ef>status</span>:
  <span style=color:#66d9ef>creationTime</span>: <span style=color:#e6db74>&#34;2019-07-15T07:59:14Z&#34;</span>
  <span style=color:#66d9ef>readyToUse</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>restoreSize</span>: 1Gi
</code></pre></div><p>Here, <code>spec.snapshotContentName</code> field specifies the name of the <code>VolumeSnapshotContent</code> crd. It also represents the actual snapshot name that has been saved in Google Cloud. If we navigate to the <code>Snapshots</code> tab in the GCP console, we should see snapshot <code>snapcontent-6f3b49a9-a6d6-11e9-9f3a-42010a800050</code> has been stored successfully.</p><figure align=center>  <img alt="Stash Backup Flow" src=/docs/v2020.08.27-rc.0/images/guides/latest/volumesnapshot/statefulset.png><figcaption align=center>Fig: Snapshots in GCE Bucket</figcaption></figure><h2 id=restore-pvc-from-volumesnapshot>Restore PVC from VolumeSnapshot</h2><p>This section will show you how to restore PVCs from the snapshots we have taken in the earlier section.</p><p><strong>Stop Taking Backup of the Old StatefulSet:</strong></p><p>At first, let&rsquo;s stop taking any further backup of the old StatefulSet so that no backup is taken during the restore process. We are going to pause the <code>BackupConfiguration</code> that we created to backup the <code>stash-demo</code> StatefulSet. Then, Stash will stop taking any further backup for this StatefulSet. You can learn more how to pause a scheduled backup <a href=/docs/v2020.08.27-rc.0/guides/latest/advanced-use-case/pause-backup>here</a></p><p>Let&rsquo;s pause the <code>statefulset-volume-snapshot</code> BackupConfiguration,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl patch backupconfiguration -n demo statefulset-volume-snapshot --type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;merge&#34;</span> --patch<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{&#34;spec&#34;: {&#34;paused&#34;: true}}&#39;</span>
backupconfiguration.stash.appscode.com/statefulset-volume-snapshot patched
</code></pre></div><p>Now, wait for a moment. Stash will pause the BackupConfiguration. Verify that the BackupConfiguration has been paused,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get backupconfiguration -n demo
NAME                          TASK   SCHEDULE      PAUSED   AGE
statefulset-volume-snapshot          */1 * * * *   true     20m
</code></pre></div><p>Notice the <code>PAUSED</code> column. Value <code>true</code> for this field means that the BackupConfiguration has been paused.</p><p><strong>Create RestoreSession :</strong></p><p>At first, we have to create a <code>RestoreSession</code> crd to restore PVCs from respective the snapshots.</p><p>Below is the YAML of the <code>RestoreSesion</code> crd that we are going to create,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: stash.appscode.com/v1beta1
<span style=color:#66d9ef>kind</span>: RestoreSession
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: restore-pvc
  <span style=color:#66d9ef>namespace</span>: demo
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>driver</span>: VolumeSnapshotter
  <span style=color:#66d9ef>target</span>:
    <span style=color:#66d9ef>replicas </span>: <span style=color:#ae81ff>3</span>
    <span style=color:#66d9ef>volumeClaimTemplates</span>:
    - <span style=color:#66d9ef>metadata</span>:
        <span style=color:#66d9ef>name</span>: restore-data-restore-demo-${POD_ORDINAL}
      <span style=color:#66d9ef>spec</span>:
        <span style=color:#66d9ef>accessModes</span>: [ <span style=color:#e6db74>&#34;ReadWriteOnce&#34;</span> ]
        <span style=color:#66d9ef>storageClassName</span>: <span style=color:#e6db74>&#34;standard&#34;</span>
        <span style=color:#66d9ef>resources</span>:
          <span style=color:#66d9ef>requests</span>:
            <span style=color:#66d9ef>storage</span>: 1Gi
        <span style=color:#66d9ef>dataSource</span>:
          <span style=color:#66d9ef>kind</span>: VolumeSnapshot
<span style=color:#75715e>#            name: source-data-stash-demo-${POD_ORDINAL}-1563177551</span>
          <span style=color:#66d9ef>name</span>: source-data-stash-demo<span style=color:#ae81ff>-0-1563181264</span>
</code></pre></div><p>Here,</p><ul><li><code>spec.target.replicas</code>: <code>spec.target.replicas</code> specify the number of replicas of a StatefulSet whose volumes were backed up and Stash uses this field to dynamically create the desired number of PVCs and initialize them from respective or Specific VolumeSnapShots.</li><li><code>spec.target.volumeClaimTemplates</code>:<ul><li><p><code>metadata.name</code> is a template for the name of the restored PVC that will be created by Stash. You have to provide this named template to match with the desired PVC of a StatefulSet. For example, if you want to deploy a StatefulSet named <code>stash-demo</code> with <code>volumeClaimTemplate</code> name <code>my-volume</code>, the PVCs of your StatefulSet will be <code>my-volume-stash-demo-0</code>, <code>my-volume-stash-demo-1</code> and so on. In this case, you have to provide <code>volumeClaimTemplate</code> name in <code>RestoreSession</code> in the following format:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&lt;volume claim name&gt;-&lt;statefulset name&gt;-<span style=color:#e6db74>${</span>POD_ORDINAL<span style=color:#e6db74>}</span>
</code></pre></div><p>So for the above example, <code>volumeClaimTemplate</code> name for <code>RestoreSession</code> will be <code>my-volume-stash-demo-${POD_ORDINAL}</code>.</p></li><li><p><code>spec.dataSource</code>: <code>spec.dataSource</code> specifies the source of the data from where the newly created PVC will be initialized. It requires following fields to be set:</p><ul><li><p><code>apiGroup</code> is the group for resource being referenced. Now, Kubernetes supports only <code>snapshot.storage.k8s.io</code>.</p></li><li><p><code>kind</code> is resource of the kind being referenced. Now, Kubernetes supports only <code>VolumeSnapshot</code>.</p></li><li><p><code>name</code> is the <code>VolumeSnapshot</code> resource name. In <code>RestoreSession</code> crd, You must provide the name in the following format:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&lt;VolumeSnapshot name prefix&gt;-<span style=color:#e6db74>${</span>POD_ORDINAL<span style=color:#e6db74>}</span>-&lt;timestamp in Unix  epoch seconds&gt;
</code></pre></div><p>The <code>${POD_ORDINAL}</code> variable is resolved by Stash. If you don&rsquo;t provide this variable and specify ordinal manually, all the PVC will be restored from the same VolumeSnapshot.</p></li></ul></li></ul></li></ul><p>Let&rsquo;s create the <code>RestoreSession</code> crd we have shown above.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl create -f ./docs/examples/guides/latest/volumesnapshot/statefulset/restoresession.yaml
restoresession.stash.appscode.com/restore-pvc created
</code></pre></div><p>Once, you have created the <code>RestoreSession</code> crd, Stash will create a job to restore. We can watch the <code>RestoreSession</code> phase to check if the restore process has succeeded or not.</p><p>Run the following command to watch RestoreSession phase,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ watch -n <span style=color:#ae81ff>1</span> kubectl get restore -n demo
Every 1.0s: kubectl get restore -n demo                      suaas-appscode: Tue Jun <span style=color:#ae81ff>18</span> 18:35:41 <span style=color:#ae81ff>2019</span>

NAME          REPOSITORY-NAME   PHASE       AGE
restore-pvc                     Running     10s
restore-pvc                     Succeeded   1m
</code></pre></div><p>So, we can see from the output of the above command that the restore process succeeded.</p><p><strong>Verify Restored PVC :</strong></p><p>Once the restore process is complete, we are going to see that new PVCs with the name <code>restore-data-restore-demo-0</code> , <code>restore-data-restore-demo-1</code> and <code>restore-data-restore-demo-2</code> has been created.</p><p>Verify that the PVCs has been created by the following command,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get pvc -n demo
NAME                          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
restore-data-restore-demo-0   Bound    pvc-ed35c54d-a6dc-11e9-9f3a-42010a800050   1Gi        RWO            standard       13s
restore-data-restore-demo-1   Bound    pvc-ed3bcb82-a6dc-11e9-9f3a-42010a800050   1Gi        RWO            standard       13s
restore-data-restore-demo-2   Bound    pvc-ed3fed79-a6dc-11e9-9f3a-42010a800050   1Gi        RWO            standard       13s
</code></pre></div><p>Notice the <code>STATUS</code> field. It indicates that the respective PV has been provisioned and initialized from the respective VolumeSnapshot by CSI driver and the PVC has been bound with the PV.</p><blockquote><p>The <a href=https://kubernetes.io/docs/concepts/storage/storage-classes/#volume-binding-mode>volumeBindingMode</a> field controls when volume binding and dynamic provisioning should occur. Kubernetes allows <code>Immediate</code> and <code>WaitForFirstConsumer</code> modes for binding volumes. The <code>Immediate</code> mode indicates that volume binding and dynamic provisioning occurs once the PVC is created and <code>WaitForFirstConsumer</code> mode indicates that volume binding and provisioning does not occur until a pod is created that uses this PVC. By default <code>volumeBindingMode</code> is <code>Immediate</code>.</p></blockquote><blockquote><p>If you use <code>volumeBindingMode: WaitForFirstConsumer</code>, respective PVC will be initialized from respective VolumeSnapshot after you create a workload with that PVC. In this case, Stash will mark the restore session as completed with phase <code>Unknown</code>.</p></blockquote><p><strong>Verify Restored Data :</strong></p><p>We are going to create a new Statefulset with the restored PVCs to verify whether the backed up data has been restored.</p><p>Below, the YAML for the Statefulset we are going to create.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: v1
<span style=color:#66d9ef>kind</span>: Service
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: restore-svc
  <span style=color:#66d9ef>labels</span>:
    <span style=color:#66d9ef>app</span>: restore-demo
  <span style=color:#66d9ef>namespace</span>: demo
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>ports</span>:
  - <span style=color:#66d9ef>port</span>: <span style=color:#ae81ff>80</span>
    <span style=color:#66d9ef>name</span>: web
  <span style=color:#66d9ef>clusterIP</span>: None
  <span style=color:#66d9ef>selector</span>:
    <span style=color:#66d9ef>app</span>: restore-demo
---
<span style=color:#66d9ef>apiVersion</span>: apps/v1
<span style=color:#66d9ef>kind</span>: StatefulSet
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: restore-demo
  <span style=color:#66d9ef>namespace</span>: demo
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>selector</span>:
    <span style=color:#66d9ef>matchLabels</span>:
      <span style=color:#66d9ef>app</span>: restore-demo
  <span style=color:#66d9ef>serviceName</span>: svc
  <span style=color:#66d9ef>replicas</span>: <span style=color:#ae81ff>3</span>
  <span style=color:#66d9ef>template</span>:
    <span style=color:#66d9ef>metadata</span>:
      <span style=color:#66d9ef>labels</span>:
        <span style=color:#66d9ef>app</span>: restore-demo
    <span style=color:#66d9ef>spec</span>:
      <span style=color:#66d9ef>containers</span>:
      - <span style=color:#66d9ef>args</span>:
        - sleep
        - <span style=color:#e6db74>&#34;3600&#34;</span>
        <span style=color:#66d9ef>name</span>: nginx
        <span style=color:#66d9ef>image</span>: nginx
        <span style=color:#66d9ef>ports</span>:
        - <span style=color:#66d9ef>containerPort</span>: <span style=color:#ae81ff>80</span>
          <span style=color:#66d9ef>name</span>: web
        <span style=color:#66d9ef>volumeMounts</span>:
        - <span style=color:#66d9ef>name</span>: restore-data
          <span style=color:#66d9ef>mountPath</span>: /restore/data
  <span style=color:#66d9ef>volumeClaimTemplates</span>:
    - <span style=color:#66d9ef>metadata</span>:
        <span style=color:#66d9ef>name</span>: restore-data
        <span style=color:#66d9ef>namespace</span>: demo
      <span style=color:#66d9ef>spec</span>:
        <span style=color:#66d9ef>accessModes</span>:
        - ReadWriteOnce
        <span style=color:#66d9ef>storageClassName</span>: standard
        <span style=color:#66d9ef>resources</span>:
          <span style=color:#66d9ef>requests</span>:
            <span style=color:#66d9ef>storage</span>: 1Gi
</code></pre></div><p>Let&rsquo;s create the Statefulset we have shown above.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl create -f ./docs/examples/guides/latest/volumesnapshot/statefulset/restored-statefulset.yaml
service/svc created
statefulset.apps/restore-demo created
</code></pre></div><p>Now, wait for the pod of the Statefulset to go into the <code>Running</code> state.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get pod -n demo
NAME             READY   STATUS    RESTARTS   AGE
restore-demo-0   1/1     Running   <span style=color:#ae81ff>0</span>          65s
restore-demo-1   1/1     Running   <span style=color:#ae81ff>0</span>          46s
restore-demo-2   1/1     Running   <span style=color:#ae81ff>0</span>          26s
</code></pre></div><p>Verify that the backed up data has been restored in <code>/restore/data</code> directory using the following command,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl exec -n demo restore-demo-0 -- cat /restore/data/data.txt
stash-demo-0
$ kubectl exec -n demo restore-demo-1 -- cat /restore/data/data.txt
stash-demo-1
$ kubectl exec -n demo restore-demo-2 -- cat /restore/data/data.txt
stash-demo-2
</code></pre></div><h2 id=advance-use-case>Advance Use-Case</h2><p>Stash can also backup only single replica or restore same data on all replicas of a StatefulSet. This is particularly useful when all replicas of the StatefulSet contains same data. For example, in <a href=https://kubedb.com/docs/0.12.0/guides/mongodb/clustering/replication_concept/>MongoDB ReplicaSet</a> all the pod contains same data. In this case backup only single replica is enough. Similarly, it might be useful in some cases where all the replicas need to be initialized with same data.</p><h3 id=backup-only-single-replica>Backup only Single Replica</h3><p>This section will show you how to snapshot only a single replica of a Statefulset volume.</p><p><strong>Create BackupConfiguration :</strong></p><p>Now, create a <code>BackupConfiguration</code> crd to take snapshot of a single PVC of the <code>stash-demo</code> Statefulset.</p><p>Below is the YAML of the <code>BackupConfiguration</code> that we are going to create,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: stash.appscode.com/v1beta1
<span style=color:#66d9ef>kind</span>: BackupConfiguration
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: statefulset-volume-snapshot
  <span style=color:#66d9ef>namespace</span>: demo
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>schedule</span>: <span style=color:#e6db74>&#34;*/5 * * * *&#34;</span>
  <span style=color:#66d9ef>driver</span>: VolumeSnapshotter
  <span style=color:#66d9ef>target</span>:
    <span style=color:#66d9ef>ref</span>:
      <span style=color:#66d9ef>apiVersion</span>: apps/v1
      <span style=color:#66d9ef>kind</span>: StatefulSet
      <span style=color:#66d9ef>name</span>: stash-demo
      <span style=color:#66d9ef>replicas </span>: <span style=color:#ae81ff>1</span>
    <span style=color:#66d9ef>snapshotClassName</span>: default-snapshot-class
  <span style=color:#66d9ef>retentionPolicy</span>:
    <span style=color:#66d9ef>name</span>: <span style=color:#e6db74>&#39;keep-last-5&#39;</span>
    <span style=color:#66d9ef>keepLast</span>: <span style=color:#ae81ff>5</span>
    <span style=color:#66d9ef>prune</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><p>Here,</p><ul><li><code>spec.replicas</code> specifies the number of replicas (starting from 0th) whose data should be backed up. If it is set to 1, Stash will take snapshot only the volumes of <code>&lt;claim-name>-&lt;statefulset-name>-0</code> pod. For replica set to 2, Stash will take snapshot only the volumes of <code>&lt;claim-name>-&lt;statefulset-name>-0</code> and <code>&lt;claim-name>-&lt;statefulset-name>-1</code> pods and so on.</li></ul><p>Let&rsquo;s create the <code>BackupConfiguration</code> crd we have shown above.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl apply -f https://github.com/stashed/docs/raw/v2020.08.27-rc.0/docs/examples/guides/latest/volumesnapshot/statefulset/backupconfiguration.yaml
backupconfiguration.stash.appscode.com/statefulset-volume-snapshot created
</code></pre></div><p><strong>Verify CronJob :</strong></p><p>If everything goes well, Stash will create a <code>CronJob</code> to take periodic snapshot of <code>stash-demo-0</code> volume of the Statefulset with the schedule specified in <code>spec.schedule</code> field of <code>BackupConfiguration</code> crd.</p><p>Check that the <code>CronJob</code> has been created using the following command,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get cronjob -n demo
NAME                          SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
statefulset-volume-snapshot   */1 * * * *   False     <span style=color:#ae81ff>0</span>        &lt;none&gt;          18s
</code></pre></div><p><strong>Wait for BackupSession :</strong></p><p>The <code>statefulset-volume-snapshot</code> CronJob will trigger a backup on each schedule by creating a <code>BackupSession</code> crd.</p><p>Wait for the next schedule for backup. Run the following command to watch <code>BackupSession</code> crd,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ watch -n <span style=color:#ae81ff>1</span> kubectl get backupsession -n demo
Every 1.0s: kubectl get backupsession -n demo                      suaas-appscode: Tue Jun <span style=color:#ae81ff>18</span> 18:35:41 <span style=color:#ae81ff>2019</span>

NAME                                     INVOKER-TYPE          INVOKER-NAME                  PHASE       AGE
statefulset-volume-snapshot-1563181264   BackupConfiguration   statefulset-volume-snapshot   Succeeded   57s
</code></pre></div><p>We can see above that the backup session has succeeded. Now, we are going to verify that the VolumeSnapshot has been created and the snapshot has been stored in the respective backend.</p><p><strong>Verify Volume Snapshotting and Backup :</strong></p><p>Once a <code>BackupSession</code> crd is created, Stash creates a volume snapshotter <code>Job</code>. Then the <code>Job</code> creates <code>VolumeSnapshot</code> crd for the targeted PVC. The <code>VolumeSnapshot</code> name follows the following pattern:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> &lt;PVC claim name&gt;-&lt;backup session creation timestamp in Unix epoch seconds&gt;
</code></pre></div><p>Check that the <code>VolumeSnapshot</code> has been created Successfully.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get volumesnapshot -n demo
NAME                                  AGE
source-data-stash-demo-0-1563181264   67s
</code></pre></div><p>Let&rsquo;s find out the actual snapshot name that will be saved in the GCP by the following command,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get volumesnapshot source-data-stash-demo-0-1563181264 -n demo -o yaml
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: snapshot.storage.k8s.io/v1alpha1
<span style=color:#66d9ef>kind</span>: VolumeSnapshot
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>creationTimestamp</span>: <span style=color:#e6db74>&#34;2019-07-15T09:01:06Z&#34;</span>
  <span style=color:#66d9ef>finalizers</span>:
  - snapshot.storage.kubernetes.io/volumesnapshot-protection
  <span style=color:#66d9ef>generation</span>: <span style=color:#ae81ff>4</span>
  <span style=color:#66d9ef>name</span>: source-data-stash-demo<span style=color:#ae81ff>-0-1563181264</span>
  <span style=color:#66d9ef>namespace</span>: demo
  <span style=color:#66d9ef>resourceVersion</span>: <span style=color:#e6db74>&#34;24310&#34;</span>
  <span style=color:#66d9ef>selfLink</span>: /apis/snapshot.storage.k8s.io/v1alpha1/namespaces/demo/volumesnapshots/source-data-stash-demo<span style=color:#ae81ff>-0-1563181264</span>
  <span style=color:#66d9ef>uid</span>: 14984cd3-a6df<span style=color:#ae81ff>-11e9</span>-9f3a-42010a800050
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>snapshotClassName</span>: default-snapshot-class
  <span style=color:#66d9ef>snapshotContentName</span>: snapcontent-14984cd3-a6df<span style=color:#ae81ff>-11e9</span>-9f3a-42010a800050
  <span style=color:#66d9ef>source</span>:
    <span style=color:#66d9ef>apiGroup</span>: <span style=color:#66d9ef>null</span>
    <span style=color:#66d9ef>kind</span>: PersistentVolumeClaim
    <span style=color:#66d9ef>name</span>: source-data-stash-demo<span style=color:#ae81ff>-0</span>
<span style=color:#66d9ef>status</span>:
  <span style=color:#66d9ef>creationTime</span>: <span style=color:#e6db74>&#34;2019-07-15T09:01:07Z&#34;</span>
  <span style=color:#66d9ef>readyToUse</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>restoreSize</span>: 1Gi
</code></pre></div><p>Here, <code>spec.snapshotContentName</code> field specifies the name of the <code>VolumeSnapshotContent</code> crd. It also represents the actual snapshot name that has been saved in GCP. If we navigate to the <code>Snapshots</code> tab in the GCP console, we should see the snapshot <code>snapcontent-14984cd3-a6df-11e9-9f3a-42010a800050</code> has been stored successfully.</p><figure align=center>  <img alt="Stash Backup Flow" src=/docs/v2020.08.27-rc.0/images/guides/latest/volumesnapshot/statefulset2.png><figcaption align=center>Fig: Snapshot in GCE Bucket</figcaption></figure><h3 id=restore-same-data-in-all-replicas>Restore Same Data in all Replicas</h3><p>This section will show you how to restore PVCs from the snapshot that we have taken in the earlier section.</p><p><strong>Stop Taking Backup of the Old StatefulSet:</strong></p><p>At first, let&rsquo;s stop taking any further backup of the old StatefulSet so that no backup is taken during the restore process. We are going to pause the <code>BackupConfiguration</code> that we created to backup the <code>stash-demo</code> StatefulSet. Then, Stash will stop taking any further backup for this StatefulSet. You can learn more how to pause a scheduled backup <a href=/docs/v2020.08.27-rc.0/guides/latest/advanced-use-case/pause-backup>here</a></p><p>Let&rsquo;s pause the <code>statefulset-volume-snapshot</code> BackupConfiguration,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl patch backupconfiguration -n demo statefulset-volume-snapshot --type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;merge&#34;</span> --patch<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{&#34;spec&#34;: {&#34;paused&#34;: true}}&#39;</span>
backupconfiguration.stash.appscode.com/statefulset-volume-snapshot patched
</code></pre></div><p>Now, wait for a moment. Stash will pause the BackupConfiguration. Verify that the BackupConfiguration has been paused,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get backupconfiguration -n demo
NAME                          TASK   SCHEDULE      PAUSED   AGE
statefulset-volume-snapshot          */1 * * * *   true     20m
</code></pre></div><p>Notice the <code>PAUSED</code> column. Value <code>true</code> for this field means that the BackupConfiguration has been paused.</p><p><strong>Create RestoreSession :</strong></p><p>At first, we have to create a <code>RestoreSession</code> crd to restore PVCs from the respective snapshot.</p><p>Below is the YAML of the <code>RestoreSesion</code> crd that we are going to create,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: stash.appscode.com/v1beta1
<span style=color:#66d9ef>kind</span>: RestoreSession
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: restore-pvc
  <span style=color:#66d9ef>namespace</span>: demo
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>driver</span>: VolumeSnapshotter
  <span style=color:#66d9ef>target</span>:
    <span style=color:#66d9ef>replicas </span>: <span style=color:#ae81ff>3</span>
    <span style=color:#66d9ef>volumeClaimTemplates</span>:
      - <span style=color:#66d9ef>metadata</span>:
          <span style=color:#66d9ef>name</span>: restore-data-restore-demo-${POD_ORDINAL}
        <span style=color:#66d9ef>spec</span>:
          <span style=color:#66d9ef>accessModes</span>: [ <span style=color:#e6db74>&#34;ReadWriteOnce&#34;</span> ]
          <span style=color:#66d9ef>storageClassName</span>: <span style=color:#e6db74>&#34;standard&#34;</span>
          <span style=color:#66d9ef>resources</span>:
            <span style=color:#66d9ef>requests</span>:
              <span style=color:#66d9ef>storage</span>: 1Gi
          <span style=color:#66d9ef>dataSource</span>:
            <span style=color:#66d9ef>kind</span>: VolumeSnapshot
            <span style=color:#66d9ef>name</span>: source-data-stash-demo<span style=color:#ae81ff>-0-1563181264</span>
<span style=color:#75715e>#            name: source-data-stash-demo-${POD_ORDINAL}-1563177551</span>
            <span style=color:#66d9ef>apiGroup</span>: snapshot.storage.k8s.io
</code></pre></div><p>Here,</p><ul><li><code>spec.dataSource.name</code>: <code>spec.dataSource.name</code> is the <code>VolumeSnapshot</code> resource name. data will be restored in all replica from single VolumeSnapshot.</li></ul><p>Let&rsquo;s create the <code>BackupConfiguration</code> crd we have shown above.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl create -f ./docs/examples/guides/latest/volumesnapshot/statefulset/restoresession.yaml
restoresession.stash.appscode.com/restore-pvc created
</code></pre></div><p>Once, you have created the <code>RestoreSession</code> crd, Stash will create a job to restore. We can watch the <code>RestoreSession</code> phase to check if the restore process has succeeded or not.</p><p>Run the following command to watch RestoreSession phase,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ watch -n <span style=color:#ae81ff>1</span> kubectl get restore -n demo
Every 1.0s: kubectl get restore -n demo                      suaas-appscode: Tue Jun <span style=color:#ae81ff>18</span> 18:35:41 <span style=color:#ae81ff>2019</span>

NAME          REPOSITORY-NAME   PHASE       AGE
restore-pvc                     Running     10s
restore-pvc                     Succeeded   1m
</code></pre></div><p>So, we can see from the output of the above command that the restore process succeeded.</p><p><strong>Verify Restored PVC :</strong></p><p>Once the restore process is complete, we are going to see that new PVCs with the name <code>restore-data-restore-demo-0</code> , <code>restore-data-restore-demo-1</code> and <code>restore-data-restore-demo-2</code> have been created successfully.</p><p>check that the status of the PVCs are bound,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get pvc -n demo
NAME                          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
restore-data-restore-demo-0   Bound    pvc-745e0f51-a6e0-11e9-9f3a-42010a800050   1Gi        RWO            standard       5m23s
restore-data-restore-demo-1   Bound    pvc-746227e7-a6e0-11e9-9f3a-42010a800050   1Gi        RWO            standard       5m23s
restore-data-restore-demo-2   Bound    pvc-74674656-a6e0-11e9-9f3a-42010a800050   1Gi        RWO            standard       5m23s
</code></pre></div><p><strong>Verify Restored Data :</strong></p><p>We are going to create a new Statefulset to verify whether the restored data has been restored successfully.</p><p>Below, the YAML for the Statefulset we are going to create.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: v1
<span style=color:#66d9ef>kind</span>: Service
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: restore-svc
  <span style=color:#66d9ef>labels</span>:
    <span style=color:#66d9ef>app</span>: restore-demo
  <span style=color:#66d9ef>namespace</span>: demo
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>ports</span>:
    - <span style=color:#66d9ef>port</span>: <span style=color:#ae81ff>80</span>
      <span style=color:#66d9ef>name</span>: web
  <span style=color:#66d9ef>clusterIP</span>: None
  <span style=color:#66d9ef>selector</span>:
    <span style=color:#66d9ef>app</span>: restore-demo
---
<span style=color:#66d9ef>apiVersion</span>: apps/v1
<span style=color:#66d9ef>kind</span>: StatefulSet
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: restore-demo
  <span style=color:#66d9ef>namespace</span>: demo
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>selector</span>:
    <span style=color:#66d9ef>matchLabels</span>:
      <span style=color:#66d9ef>app</span>: restore-demo
  <span style=color:#66d9ef>serviceName</span>: svc
  <span style=color:#66d9ef>replicas</span>: <span style=color:#ae81ff>3</span>
  <span style=color:#66d9ef>template</span>:
    <span style=color:#66d9ef>metadata</span>:
      <span style=color:#66d9ef>labels</span>:
        <span style=color:#66d9ef>app</span>: restore-demo
    <span style=color:#66d9ef>spec</span>:
      <span style=color:#66d9ef>containers</span>:
        - <span style=color:#66d9ef>args</span>:
            - sleep
            - <span style=color:#e6db74>&#34;3600&#34;</span>
          <span style=color:#66d9ef>name</span>: nginx
          <span style=color:#66d9ef>image</span>: nginx
          <span style=color:#66d9ef>ports</span>:
            - <span style=color:#66d9ef>containerPort</span>: <span style=color:#ae81ff>80</span>
              <span style=color:#66d9ef>name</span>: web
          <span style=color:#66d9ef>volumeMounts</span>:
            - <span style=color:#66d9ef>name</span>: restore-data
              <span style=color:#66d9ef>mountPath</span>: /restore/data
  <span style=color:#66d9ef>volumeClaimTemplates</span>:
    - <span style=color:#66d9ef>metadata</span>:
        <span style=color:#66d9ef>name</span>: restore-data
        <span style=color:#66d9ef>namespace</span>: demo
      <span style=color:#66d9ef>spec</span>:
        <span style=color:#66d9ef>accessModes</span>:
          - ReadWriteOnce
        <span style=color:#66d9ef>storageClassName</span>: standard
        <span style=color:#66d9ef>resources</span>:
          <span style=color:#66d9ef>requests</span>:
            <span style=color:#66d9ef>storage</span>: 1Gi
</code></pre></div><p>Let&rsquo;s create the Statefulset we have shown above.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl create -f ./docs/examples/guides/latest/volumesnapshot/statefulset/restored-statefulset.yaml
service/svc created
statefulset.apps/restore-demo created
</code></pre></div><p>Now, wait for the pod of Statefulset to go into the <code>Running</code> state.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get pod -n demo
NAME             READY   STATUS    RESTARTS   AGE
restore-demo-0   1/1     Running   <span style=color:#ae81ff>0</span>          3m9s
restore-demo-1   1/1     Running   <span style=color:#ae81ff>0</span>          2m50s
restore-demo-2   1/1     Running   <span style=color:#ae81ff>0</span>          2m30s
</code></pre></div><p>Verify that the backed up data has been restored in <code>/restore/data</code> directory using the following command,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl exec -n demo restore-demo-0 -- cat /restore/data/data.txt
stash-demo-0
$ kubectl exec -n demo restore-demo-1 -- cat /restore/data/data.txt
stash-demo-0
$ kubectl exec -n demo restore-demo-2 -- cat /restore/data/data.txt
stash-demo-0
</code></pre></div><h2 id=cleaning-up>Cleaning Up</h2><p>To clean up the Kubernetes resources created by this tutorial, run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete -n demo statefulset stash-demo
kubectl delete -n demo statefulset restore-demo
kubectl delete -n demo backupconfiguration statefulset-volume-snapshot
kubectl delete -n demo restoresession restore-pvc
kubectl delete -n demo storageclass standard
kubectl delete -n demo volumesnapshotclass default-snapshot-class
</code></pre></div></div></div><div class="column is-2"><div class=right-sidebar-area><div class=search-area><form action=#><input id=acSearch type=text placeholder=Search...>
<button class=search-button>
<i class="fa fa-search" aria-hidden=true></i></button></form></div><div class=tbl-of-contents><h4>What's on this Page</h4><nav id=TableOfContents><ul><li><a href=#before-you-begin>Before You Begin</a></li><li><a href=#prepare-for-volumesnapshot>Prepare for VolumeSnapshot</a></li><li><a href=#take-volume-snapshot>Take Volume Snapshot</a></li><li><a href=#restore-pvc-from-volumesnapshot>Restore PVC from VolumeSnapshot</a></li><li><a href=#advance-use-case>Advance Use-Case</a><ul><li><a href=#backup-only-single-replica>Backup only Single Replica</a></li><li><a href=#restore-same-data-in-all-replicas>Restore Same Data in all Replicas</a></li></ul></li><li><a href=#cleaning-up>Cleaning Up</a></li></ul></nav></div></div></div></div></div><script>var kdDropdown=document.querySelector(".dropdown");var kdDropdownBtn=document.querySelector(".dropdown-trigger");kdDropdownBtn.addEventListener("click",function(){kdDropdown.classList.toggle("is-active");})</script></div><div class=overlay-bg></div><div class=sidebar-search-area><div class=search-area-top><h3>Search</h3><div class=searchbar-area><input type=search name=search id=searchbox placeholder=Search...>
<button onclick=queryPage(1)><i class="fa fa-search" aria-hidden=true></i></button></div><span id=searchbar-script-container style=display:none></span><div class="search-meta-information level"><div class=level-left></div></div></div><div class=search-result-wrapper></div><div class=pagination-area><div class=pagination-list></div></div></div><div class=improve-section-area><div class="container section"><div class=improve-bg-color><div class=columns><div class="column is-6"><a href=https://github.com/stashed/docs/edit/master/docs/guides/latest/volumesnapshot/statefulset.md/>Improve This Page</a></div></div></div></div></div><script type=text/javascript>var pageSize=5;var acSearch=document.querySelector("#acSearch");var bodyOverlay=document.querySelector(".overlay-bg");var sidebarSearch=document.querySelector(".sidebar-search-area");acSearch.addEventListener("click",function(){bodyOverlay.style.display="block";sidebarSearch.style.right="0";document.getElementById("searchbox").focus();bodyOverlay.addEventListener("click",function(){bodyOverlay.style.display="none";sidebarSearch.style.right="-80%";});});function encodeQueryData(data){var ret=[];for(var d in data)
ret.push(encodeURIComponent(d)+'='+encodeURIComponent(data[d]));return ret.join('&');}
document.querySelector(".searchbar-area input[type=search]").addEventListener("keyup",function(event){event.preventDefault();if(event.keyCode===13){queryPage(1);}});function queryPage(idx){var q=document.getElementById("searchbox").value;var cx="015199383701854252104:0pfqfvpvwyl";var key="AIzaSyBo15AW3hatf4fO8actJUZ_d5qZJpx0rXM";var imgSize="small";var callback="renderResult";var src="https://www.googleapis.com/customsearch/v1?"+encodeQueryData({q:q,cx:cx,key:key,imgSize:imgSize,callback:callback,start:(idx-1)*pageSize+1,num:pageSize,});var newScript=document.createElement("script");newScript.src=src;e=document.getElementById("searchbar-script-container");var child=e.lastElementChild;if(child){e.removeChild(child);}
e.appendChild(newScript);}
function renderSearchResultEntry(e){var out='<div class="single-search-result">'+
'<h3><a href="'+e.link+'">'+e.title+'</a></h3>'+
'<a href="'+e.link+'">'+e.htmlFormattedUrl+'</a>'+
'<div class="result-description-wrapper">';if(e.pagemap&&e.pagemap.cse_thumbnail){out+='<div class="result-thumb">'+
'<img src="'+e.pagemap.cse_thumbnail[0].src+'" alt="" />'+
'</div>';}
out+='<div class="result-description">'+
'<p>'+
e.snippet+
'</p>'+
'</div>'+
'</div>'+
'</div>';return out;}
function renderResult(response){document.querySelector(".search-meta-information .level-left").innerHTML='<div class="level-left">'+
'<p>'+
'About <span class="search-count">'+response.searchInformation.formattedTotalResults+'</span> results (<span class="time-count">'+response.searchInformation.formattedSearchTime+' </span>seconds)'+
'</p>'+
'</div>';if(!response.items){return;}
var searchResultWrapper=document.querySelector(".search-result-wrapper");searchResultWrapper.innerHTML="";for(var i=0;i<response.items.length;i++){searchResultWrapper.innerHTML+=renderSearchResultEntry(response.items[i]);}
var pager='<ul>';if(response.queries.previousPage){var pageIndex=Math.floor(response.queries.previousPage[0].startIndex/pageSize)+1;pager+='<li><a href="#" onclick="queryPage('+pageIndex+')">Previous</a></li>';}
if(response.queries.request){var pageIndex=Math.floor(response.queries.request[0].startIndex/pageSize)+1;pager+='<li><a href="#" onclick="queryPage('+pageIndex+')" class="is-active">'+pageIndex+'</a></li>';}
if(response.queries.nextPage){var pageIndex=Math.floor(response.queries.nextPage[0].startIndex/pageSize)+1;pager+='<li><a href="#" onclick="queryPage('+pageIndex+')">Next</a></li>';}
pager+='</ul>';document.querySelector(".pagination-area .pagination-list").innerHTML=pager;}</script><section></section><section></section><section></section><button class=go-to-top id=goTop>
<i class="fa fa-angle-up" aria-hidden=true></i></button><footer class=footer-area><div class=footer-top><div class="container section"><div class="columns is-mobile is-multiline"><div class="column is-full-mobile is-one-third-desktop is-one-third-widescreen is-one-third-tablet" data-aos=fade-up><div class=single-footer-widget><div class=footer-logo><a href=https://appscode.com><img src=/assets/images/products/appscode/appscode.png alt=AppsCode class=img></a></div><div class=subscription-form><form action="https://appscode.us17.list-manage.com/subscribe/post?u=feb2bf31969a951e7449048a3&id=82fb19acb9" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=navbar-form target=_blank novalidate role=email role=email><label for=email>Subscribe to Our Newsletter</label><p class=spam-message>No spam, we promise. Your mail address is secure</p><div class="field has-addons"><div class=control><input class=input name=EMAIL id=mce-EMAIL type=email placeholder="Your work email address" required>
<button id=mc-embedded-subscribe type=submit name=subscribe class=button>
<i class="fa fa-paper-plane-o" aria-hidden=true></i></button></div></div></form></div><div class=contact-information><h4>Have any Inquiry?</h4><ul class=all-contact-info><li><a href=callto:+1%28650%29241-8486><span><i class="fa fa-phone" aria-hidden=true></i></span>+1(650)241-8486</a></li><li><a href=mailto:support@appscode.com><span><i class="fa fa-envelope-o" aria-hidden=true></i></span>support@appscode.com</a></li></ul></div></div></div><div class="column is-half-mobile" data-aos=fade-up data-aos-duration=500><div class=single-footer-widget><div class=footer-menu><h4>Products</h4><ul class=footer-link><li><a href=https://kubedb.com>KubeDB</a></li><li><a href=https://stash.run>Stash</a></li><li><a href=https://kubevault.com>KubeVault</a></li><li><a href>Voyager</a></li><li><a href=https://appscode.com/products/guard/>Guard</a></li><li><a href=https://pharmer.io>Pharmer</a></li></ul></div></div></div><div class="column is-half-mobile" data-aos=fade-up data-aos-duration=600><div class=single-footer-widget><div class=footer-menu><h4>Services</h4><ul class=footer-link><li><a href=https://appscode.com/pricing/>Pricing</a></li><li><a href=https://appscode.com/consulting/>Consulting</a></li><li><a href=https://appscode.com/training/>Training</a></li><li><a href=https://appscode.com/support/>Support</a></li></ul></div></div></div><div class="column is-half-mobile" data-aos=fade-up data-aos-duration=700><div class=single-footer-widget><div class=footer-menu><h4>Company</h4><ul class=footer-link><li><a href=https://appscode.com/about/>About Us</a></li><li><a href=https://blog.byte.builders>Blog</a></li><li><a href=https://appscode.com/contact/>Contact Us</a></li></ul></div></div></div><div class="column is-half-mobile" data-aos=fade-up data-aos-duration=800><div class=single-footer-widget><div class=footer-menu><h4>Legal</h4><ul class=footer-link><li><a href=https://appscode.com/legal/tos/>Terms of Sevice</a></li><li><a href=https://appscode.com/legal/privacy-policy/>Privacy Policy</a></li><li><a href=https://appscode.com/legal/security/>Security</a></li><li><a href=https://appscode.com/legal/sla/>Service Level Agreement</a></li></ul></div></div></div></div></div></div><div class=footer-bottom><div class="container section"><div class=columns><div class="column is-4"><p>© 2020 AppsCode Inc. All rights reserved.</p></div><div class="column is-4 is-mobile has-text-centered"><div class=footer-inline-link><a href=https://appscode.com/legal/privacy-policy/>Privacy Policy</a>
<a href=https://appscode.com/legal/tos/>Terms of Service</a></div></div><div class="column is-4 is-mobile has-text-right"><div class=socail-link-inline><ul><li><a href=https://twitter.com/AppsCodeHQ><i class="fa fa-twitter" aria-hidden=true></i></a></li><li><a href=https://www.facebook.com/appscode><i class="fa fa-facebook" aria-hidden=true></i></a></li><li><a href=https://www.youtube.com/c/AppsCodeInc><i class="fa fa-youtube" aria-hidden=true></i></a></li></ul></div></div></div></div></div></footer><script src=/assets/js/bulma-carousel.min.js></script><script src=https://unpkg.com/aos@2.3.1/dist/aos.js></script><script src=https://unpkg.com/downloadjs@1.4.7/download.min.js></script><script src=https://unpkg.com/clipboard@2/dist/clipboard.min.js></script><script src=/assets/js/main.js></script><script type=text/javascript>var Tawk_API=Tawk_API||{},Tawk_LoadStart=new Date();(function(){var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];s1.async=true;s1.src='https://embed.tawk.to/5821e34b18d9f16af02864b7/default';s1.charset='UTF-8';s1.setAttribute('crossorigin','*');s0.parentNode.insertBefore(s1,s0);})();</script></body></html>